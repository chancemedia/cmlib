<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>CMLIB: CMFileCSV.php Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    </ul>
  </div>
<h1>CMFileCSV.php</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00002"></a>00002 
<a name="l00003"></a>00003 include_once(<span class="stringliteral">&#39;CMFileParser.php&#39;</span>);
<a name="l00004"></a>00004 include_once(<span class="stringliteral">&#39;CMError.php&#39;</span>);
<a name="l00005"></a>00005 
<a name="l00006"></a>00006 <span class="comment">// bla bla</span>
<a name="l00007"></a>00007 
<a name="l00020"></a><a class="code" href="class_c_m_file_c_s_v.html">00020</a> <span class="keyword">class </span><a class="code" href="class_c_m_file_c_s_v.html" title="Class for handling CSV (comma-separated values) files.">CMFileCSV</a> <span class="keyword">extends</span> <a class="code" href="class_c_m_error.html" title="Error handling as a stand-alone or for classes vis inheritance.">CMError</a> implements <a class="code" href="interface_c_m_file_parser.html" title="File parser interface.">CMFileParser</a> {
<a name="l00021"></a>00021  
<a name="l00027"></a><a class="code" href="class_c_m_file_c_s_v.html#a9e2d53558e7b299d52b25c13d310d7e0">00027</a>  <span class="keyword">public</span> <span class="keyword">static</span> function <a class="code" href="class_c_m_file_c_s_v.html#a9e2d53558e7b299d52b25c13d310d7e0" title="The version of this class.">Version</a>() {
<a name="l00028"></a>00028   <span class="keywordflow">return</span> <span class="stringliteral">&quot;1.0&quot;</span>;
<a name="l00029"></a>00029  }
<a name="l00030"></a>00030  
<a name="l00036"></a><a class="code" href="class_c_m_file_c_s_v.html#ab51e04ce58ff27601a503f46d611b7e6">00036</a>  <span class="keyword">public</span> <span class="keyword">static</span> function <a class="code" href="class_c_m_file_c_s_v.html#ab51e04ce58ff27601a503f46d611b7e6" title="The version this class was introduced to the library.">Since</a>() {
<a name="l00037"></a>00037   <span class="keywordflow">return</span> <span class="stringliteral">&quot;1.0&quot;</span>;
<a name="l00038"></a>00038  }
<a name="l00039"></a>00039  
<a name="l00045"></a><a class="code" href="class_c_m_file_c_s_v.html#a40acc7b8c08cfbb456cd9444cb0e8f61">00045</a>  <span class="keyword">public</span> <a class="code" href="class_c_m_file_c_s_v.html#a40acc7b8c08cfbb456cd9444cb0e8f61" title="Delimiter.">$delimiter</a> = <span class="charliteral">&#39;,&#39;</span>;
<a name="l00046"></a>00046  
<a name="l00052"></a><a class="code" href="class_c_m_file_c_s_v.html#a207ba7fe12aff1e8948477350b4cc43f">00052</a>  <span class="keyword">public</span> <a class="code" href="class_c_m_file_c_s_v.html#a207ba7fe12aff1e8948477350b4cc43f" title="Enclosure.">$enclosure</a> = <span class="charliteral">&#39;&quot;&#39;</span>;
<a name="l00053"></a>00053  
<a name="l00057"></a><a class="code" href="class_c_m_file_c_s_v.html#a23c42e7d231a63025b55e4eb7e3d4c99">00057</a>  <span class="keyword">private</span> <a class="code" href="class_c_m_file_c_s_v.html#a23c42e7d231a63025b55e4eb7e3d4c99" title="Internal file handle.">$f</a> = <span class="keyword">false</span>;
<a name="l00058"></a>00058  
<a name="l00062"></a><a class="code" href="class_c_m_file_c_s_v.html#ab2303c817e3b402b77b7f99627b9c319">00062</a>  <span class="keyword">private</span> <a class="code" href="class_c_m_file_c_s_v.html#ab2303c817e3b402b77b7f99627b9c319" title="Mapped field names.">$fields</a> = <span class="keyword">false</span>;
<a name="l00063"></a>00063  
<a name="l00076"></a><a class="code" href="class_c_m_file_c_s_v.html#a299569d6969a4792f854738be1e89120">00076</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_file_c_s_v.html#a299569d6969a4792f854738be1e89120" title="Create a new CMFileCSV with optional field names.">CMFileCSV</a>(<a class="code" href="class_c_m_file_c_s_v.html#ab2303c817e3b402b77b7f99627b9c319" title="Mapped field names.">$fields</a> = <span class="keyword">false</span>) {
<a name="l00077"></a>00077   <span class="keywordflow">if</span>(<a class="code" href="class_c_m_file_c_s_v.html#ab2303c817e3b402b77b7f99627b9c319" title="Mapped field names.">$fields</a> !== <span class="keyword">false</span>) {
<a name="l00078"></a>00078    <span class="keywordflow">if</span>(is_array(<a class="code" href="class_c_m_file_c_s_v.html#ab2303c817e3b402b77b7f99627b9c319" title="Mapped field names.">$fields</a>))
<a name="l00079"></a>00079     $this-&gt;fields = <a class="code" href="class_c_m_file_c_s_v.html#ab2303c817e3b402b77b7f99627b9c319" title="Mapped field names.">$fields</a>;
<a name="l00080"></a>00080    <span class="keywordflow">else</span> $this-&gt;<a class="code" href="class_c_m_error.html#a6d110c63a1c5103df7979612ed5209d3" title="Throw a Warning level message.">throwWarning</a>(<span class="stringliteral">&quot;The provided \$fields is not an array&quot;</span>,
<a name="l00081"></a>00081      array(<span class="stringliteral">&#39;fields&#39;</span> =&gt; <a class="code" href="class_c_m_file_c_s_v.html#ab2303c817e3b402b77b7f99627b9c319" title="Mapped field names.">$fields</a>));
<a name="l00082"></a>00082   }
<a name="l00083"></a>00083  }
<a name="l00084"></a>00084  
<a name="l00105"></a><a class="code" href="class_c_m_file_c_s_v.html#aac2d51edbe345fb73e63bafd7d505213">00105</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_file_c_s_v.html#aac2d51edbe345fb73e63bafd7d505213" title="Input a file in peices.">iterateFile</a>($uri, $a = <span class="keyword">false</span>) {
<a name="l00106"></a>00106   <span class="comment">// all we have to do with this function is setup the input file handle</span>
<a name="l00107"></a>00107   $this-&gt;f = fopen($uri, <span class="stringliteral">&quot;r&quot;</span>);
<a name="l00108"></a>00108   <span class="keywordflow">if</span>(!$this-&gt;f) {
<a name="l00109"></a>00109    $this-&gt;<a class="code" href="class_c_m_error.html#a94a6cd26c794c35133502471eca8469e" title="Throw a Error level message.">throwError</a>(<span class="stringliteral">&quot;File could not be opened&quot;</span>, array(<span class="stringliteral">&#39;uri&#39;</span> =&gt; $uri));
<a name="l00110"></a>00110    <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00111"></a>00111   }
<a name="l00112"></a>00112    
<a name="l00113"></a>00113   <span class="comment">// $a must be an array</span>
<a name="l00114"></a>00114   <span class="keywordflow">if</span>(!is_array($a))
<a name="l00115"></a>00115    $a = array($a =&gt; <span class="keyword">true</span>);
<a name="l00116"></a>00116   
<a name="l00117"></a>00117   <span class="comment">// skip lines</span>
<a name="l00118"></a>00118   <span class="keywordflow">if</span>(isset($a[<span class="stringliteral">&#39;skip&#39;</span>])) {
<a name="l00119"></a>00119    <span class="keywordflow">for</span>($i = 0; $i &lt; $a[<span class="stringliteral">&#39;skip&#39;</span>]; ++$i)
<a name="l00120"></a>00120     $this-&gt;<a class="code" href="class_c_m_file_c_s_v.html#a19c703ce1e7d565fae99689f33383e1e" title="Interate to the next line or object.">next</a>();
<a name="l00121"></a>00121   } 
<a name="l00122"></a>00122   
<a name="l00123"></a>00123   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00124"></a>00124  }
<a name="l00125"></a>00125  
<a name="l00139"></a><a class="code" href="class_c_m_file_c_s_v.html#affa1184c8126ba8154b574077d9db3ec">00139</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_file_c_s_v.html#affa1184c8126ba8154b574077d9db3ec" title="Input a string in peices.">iterateString</a>($str, $a = <span class="keyword">false</span>) {
<a name="l00140"></a>00140   <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00141"></a>00141  }
<a name="l00142"></a>00142  
<a name="l00152"></a><a class="code" href="class_c_m_file_c_s_v.html#a64355ed82ca7305a5601ecadcc1b6f4d">00152</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_file_c_s_v.html#a64355ed82ca7305a5601ecadcc1b6f4d" title="Read a CSV file.">readFile</a>($url, $a = <span class="keyword">false</span>) {
<a name="l00153"></a>00153   <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00154"></a>00154  }
<a name="l00155"></a>00155  
<a name="l00165"></a><a class="code" href="class_c_m_file_c_s_v.html#ab0ac2d7b3f8d52e2dda81db115a96ac4">00165</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_file_c_s_v.html#ab0ac2d7b3f8d52e2dda81db115a96ac4" title="Not available.">writeFile</a>($uri, $a = <span class="keyword">false</span>) {
<a name="l00166"></a>00166   <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00167"></a>00167  }
<a name="l00168"></a>00168  
<a name="l00178"></a><a class="code" href="class_c_m_file_c_s_v.html#abd982e59b25e4cbee10131891116e29e">00178</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_file_c_s_v.html#abd982e59b25e4cbee10131891116e29e" title="Parse one ore more CSV lines.">readString</a>($str, $a = <span class="keyword">false</span>) {
<a name="l00179"></a>00179   <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00180"></a>00180  }
<a name="l00181"></a>00181  
<a name="l00190"></a><a class="code" href="class_c_m_file_c_s_v.html#a993b95c56b50a5e314e292d79fc068c5">00190</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_file_c_s_v.html#a993b95c56b50a5e314e292d79fc068c5" title="Not available.">writeString</a>($a = <span class="keyword">false</span>) {
<a name="l00191"></a>00191   <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00192"></a>00192  }
<a name="l00193"></a>00193  
<a name="l00201"></a><a class="code" href="class_c_m_file_c_s_v.html#a2afd230e2b31e9ab339dd9879f17bd7d">00201</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_file_c_s_v.html#a2afd230e2b31e9ab339dd9879f17bd7d" title="The standard file extensions for this file parser.">getStandardExtensions</a>() {
<a name="l00202"></a>00202   <span class="keywordflow">return</span> array(<span class="stringliteral">&#39;.csv&#39;</span>, <span class="stringliteral">&#39;.txt&#39;</span>);
<a name="l00203"></a>00203  }
<a name="l00204"></a>00204  
<a name="l00232"></a><a class="code" href="class_c_m_file_c_s_v.html#ab119de9fb3a6520c093501aa941ebdeb">00232</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_file_c_s_v.html#ab119de9fb3a6520c093501aa941ebdeb" title="Get internet media type (originally MIME type.).">getInternetMediaTypes</a>() {
<a name="l00233"></a>00233   <span class="keywordflow">return</span> array(<span class="stringliteral">&#39;text/csv&#39;</span>, <span class="stringliteral">&#39;text/comma-separated-values&#39;</span>);
<a name="l00234"></a>00234  }
<a name="l00235"></a>00235  
<a name="l00254"></a><a class="code" href="class_c_m_file_c_s_v.html#a19c703ce1e7d565fae99689f33383e1e">00254</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_file_c_s_v.html#a19c703ce1e7d565fae99689f33383e1e" title="Interate to the next line or object.">next</a>($options = <span class="keyword">false</span>) {
<a name="l00255"></a>00255   <span class="comment">// iterateFile</span>
<a name="l00256"></a>00256   <span class="keywordflow">if</span>(get_resource_type($this-&gt;f) == <span class="stringliteral">&#39;stream&#39;</span> || get_resource_type($this-&gt;f) == <span class="stringliteral">&#39;file&#39;</span>) {
<a name="l00257"></a>00257    <span class="comment">// make sure the file handle is open and still got data left</span>
<a name="l00258"></a>00258    <span class="keywordflow">if</span>($this-&gt;f === <span class="keyword">false</span> || feof($this-&gt;f))
<a name="l00259"></a>00259     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00260"></a>00260     
<a name="l00261"></a>00261    <span class="comment">// get and split the data</span>
<a name="l00262"></a>00262    $r = fgetcsv($this-&gt;f, 4096, $this-&gt;delimiter, $this-&gt;enclosure);
<a name="l00263"></a>00263   } <span class="keywordflow">else</span>
<a name="l00264"></a>00264    <span class="keywordflow">return</span> $this-&gt;<a class="code" href="class_c_m_error.html#a6d110c63a1c5103df7979612ed5209d3" title="Throw a Warning level message.">throwWarning</a>(<span class="stringliteral">&quot;Only files and streams are allowed with iteration.&quot;</span>);
<a name="l00265"></a>00265    
<a name="l00266"></a>00266   <span class="comment">// map the field names</span>
<a name="l00267"></a>00267   <span class="keywordflow">if</span>($this-&gt;fields !== <span class="keyword">false</span>) {
<a name="l00268"></a>00268    $newr = array();
<a name="l00269"></a>00269    <span class="keywordflow">for</span>($i = 0; $i &lt; count($r); ++$i)
<a name="l00270"></a>00270     $newr[$this-&gt;fields[$i]] = $r[$i];
<a name="l00271"></a>00271    $r = $newr;
<a name="l00272"></a>00272   }
<a name="l00273"></a>00273   
<a name="l00274"></a>00274   <span class="comment">// trim off the new line if needed</span>
<a name="l00275"></a>00275   $temp = $r[count($r) - 1];
<a name="l00276"></a>00276   <span class="keywordflow">if</span>(substr($temp, strlen($temp) - 1, 1) == <span class="stringliteral">&quot;\n&quot;</span>)
<a name="l00277"></a>00277    $r[count($r) - 1] = substr($temp, 0, strlen($temp) - 1);
<a name="l00278"></a>00278   
<a name="l00279"></a>00279   <span class="keywordflow">return</span> $r;
<a name="l00280"></a>00280  }
<a name="l00281"></a>00281  
<a name="l00289"></a><a class="code" href="class_c_m_file_c_s_v.html#a3d23f68f155fbcaaadaaa90665b3800d">00289</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_file_c_s_v.html#a3d23f68f155fbcaaadaaa90665b3800d" title="File is binary?">isBinary</a>() {
<a name="l00290"></a>00290   <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00291"></a>00291  }
<a name="l00292"></a>00292  
<a name="l00297"></a><a class="code" href="class_c_m_file_c_s_v.html#a7516ca30af0db3cdbf9a7739b48ce91d">00297</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_file_c_s_v.html#a7516ca30af0db3cdbf9a7739b48ce91d" title="Return the string value of this object.">__toString</a>() {
<a name="l00298"></a>00298   <span class="keywordflow">return</span> <span class="stringliteral">&quot;&lt;&quot;</span> . get_class($this) . <span class="stringliteral">&quot;&gt;&quot;</span>;
<a name="l00299"></a>00299  }
<a name="l00300"></a>00300  
<a name="l00323"></a><a class="code" href="class_c_m_file_c_s_v.html#a84682117d78dcfc279db48d8aa3afa37">00323</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_file_c_s_v.html#a84682117d78dcfc279db48d8aa3afa37" title="Prepare a CSV file for writing.">prepareWriteFile</a>($uri, $a = <span class="keyword">false</span>) {
<a name="l00324"></a>00324   <span class="comment">// $a must be an array</span>
<a name="l00325"></a>00325   <span class="keywordflow">if</span>(!is_array($a))
<a name="l00326"></a>00326    $a = array($a =&gt; <span class="keyword">true</span>);
<a name="l00327"></a>00327   
<a name="l00328"></a>00328   <span class="comment">// this method only has to open the writing file handle</span>
<a name="l00329"></a>00329   <span class="keywordflow">if</span>(isset($a[<span class="stringliteral">&#39;append&#39;</span>]))
<a name="l00330"></a>00330    $this-&gt;f = fopen($uri, <span class="stringliteral">&quot;a+&quot;</span>);
<a name="l00331"></a>00331   <span class="keywordflow">else</span> $this-&gt;f = fopen($uri, <span class="stringliteral">&quot;w&quot;</span>);
<a name="l00332"></a>00332   
<a name="l00333"></a>00333   <span class="keywordflow">if</span>($this-&gt;f === <span class="keyword">false</span>)
<a name="l00334"></a>00334    <span class="keywordflow">return</span> $this-&gt;<a class="code" href="class_c_m_error.html#a6d110c63a1c5103df7979612ed5209d3" title="Throw a Warning level message.">throwWarning</a>(<span class="stringliteral">&quot;The output file could not be opened&quot;</span>,
<a name="l00335"></a>00335       array(<span class="stringliteral">&#39;uri&#39;</span> =&gt; $uri));
<a name="l00336"></a>00336   
<a name="l00337"></a>00337   <span class="keywordflow">return</span> $this-&gt;f !== <span class="keyword">false</span>;
<a name="l00338"></a>00338  }
<a name="l00339"></a>00339  
<a name="l00348"></a><a class="code" href="class_c_m_file_c_s_v.html#aee954a9976108ebcec479fa4a4983de7">00348</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_file_c_s_v.html#aee954a9976108ebcec479fa4a4983de7" title="Check if this class instance is in caching mode.">isCaching</a>() {
<a name="l00349"></a>00349   <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00350"></a>00350  }
<a name="l00351"></a>00351  
<a name="l00361"></a><a class="code" href="class_c_m_file_c_s_v.html#aa96227453b5fe69a6749fdb95f32cc89">00361</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_file_c_s_v.html#aa96227453b5fe69a6749fdb95f32cc89" title="Enable/disable caching for this instance.">setCache</a>($mode = <span class="keyword">true</span>) {
<a name="l00362"></a>00362   <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00363"></a>00363  }
<a name="l00364"></a>00364  
<a name="l00384"></a><a class="code" href="class_c_m_file_c_s_v.html#ad2bae0efe64fd67aafc2baad67dbf120">00384</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_file_c_s_v.html#ad2bae0efe64fd67aafc2baad67dbf120" title="Immediatly write a line to the output CSV file.">add</a>($item = <span class="keyword">false</span>) {
<a name="l00385"></a>00385   <span class="comment">// we need an open file handle</span>
<a name="l00386"></a>00386   <span class="keywordflow">if</span>($this-&gt;f === <span class="keyword">false</span>)
<a name="l00387"></a>00387    <span class="keywordflow">return</span> $this-&gt;<a class="code" href="class_c_m_error.html#a94a6cd26c794c35133502471eca8469e" title="Throw a Error level message.">throwError</a>(<span class="stringliteral">&quot;Item could not be added&quot;</span>);
<a name="l00388"></a>00388    
<a name="l00389"></a>00389   <span class="comment">// item must be an array or we fail</span>
<a name="l00390"></a>00390   <span class="keywordflow">if</span>(!is_array($item))
<a name="l00391"></a>00391    <span class="keywordflow">return</span> $this-&gt;<a class="code" href="class_c_m_error.html#a94a6cd26c794c35133502471eca8469e" title="Throw a Error level message.">throwError</a>(<span class="stringliteral">&quot;\$item is not an array&quot;</span>, array(<span class="stringliteral">&#39;item&#39;</span> =&gt; $item));
<a name="l00392"></a>00392   
<a name="l00393"></a>00393   $success = fputcsv($this-&gt;f, $item, $this-&gt;delimiter, $this-&gt;enclosure);
<a name="l00394"></a>00394   <span class="keywordflow">if</span>(!$success)
<a name="l00395"></a>00395    <span class="keywordflow">return</span> $this-&gt;<a class="code" href="class_c_m_error.html#a94a6cd26c794c35133502471eca8469e" title="Throw a Error level message.">throwError</a>(<span class="stringliteral">&quot;Item could not be added&quot;</span>);
<a name="l00396"></a>00396    
<a name="l00397"></a>00397   <span class="keywordflow">return</span> $success;
<a name="l00398"></a>00398  }
<a name="l00399"></a>00399  
<a name="l00410"></a><a class="code" href="class_c_m_file_c_s_v.html#ad51812b2aa2b726688c27570a13d3937">00410</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_file_c_s_v.html#ad51812b2aa2b726688c27570a13d3937" title="Close and flush the writing file handle.">finishWriteFile</a>() {
<a name="l00411"></a>00411   <span class="keywordflow">if</span>($this-&gt;f !== <span class="keyword">false</span>)
<a name="l00412"></a>00412    fclose($this-&gt;f);
<a name="l00413"></a>00413   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00414"></a>00414  }
<a name="l00415"></a>00415  
<a name="l00416"></a>00416 }
<a name="l00417"></a>00417 
<a name="l00418"></a>00418 ?&gt;
</pre></div></div>
<hr class="footer"/><address style="text-align: right;"><small>Generated by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
