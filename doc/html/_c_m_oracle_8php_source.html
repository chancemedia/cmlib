<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>CMLIB: CMOracle.php Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    </ul>
  </div>
<h1>CMOracle.php</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00002"></a>00002 
<a name="l00003"></a>00003 include_once(<span class="stringliteral">&quot;CMDatabaseProtocol.php&quot;</span>);
<a name="l00004"></a>00004 include_once(<span class="stringliteral">&quot;CMOracleQuery.php&quot;</span>);
<a name="l00005"></a>00005 include_once(<span class="stringliteral">&quot;CMConstant.php&quot;</span>);
<a name="l00006"></a>00006 include_once(<span class="stringliteral">&quot;CMError.php&quot;</span>);
<a name="l00007"></a>00007 include_once(<span class="stringliteral">&quot;CMDecimal.php&quot;</span>);
<a name="l00008"></a>00008 
<a name="l00009"></a>00009 <span class="keywordflow">if</span>(!function_exists(<span class="stringliteral">&quot;oci_parse&quot;</span>)) {
<a name="l00010"></a>00010  function oci_parse($a) {
<a name="l00011"></a>00011   <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00012"></a>00012  }
<a name="l00013"></a>00013 }
<a name="l00014"></a>00014 
<a name="l00015"></a>00015 <span class="keywordflow">if</span>(!function_exists(<span class="stringliteral">&quot;oci_execute&quot;</span>)) {
<a name="l00016"></a>00016  function oci_execute($a) {
<a name="l00017"></a>00017   <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00018"></a>00018  }
<a name="l00019"></a>00019 }
<a name="l00020"></a>00020 
<a name="l00021"></a>00021 <span class="keywordflow">if</span>(!function_exists(<span class="stringliteral">&quot;oci_connect&quot;</span>)) {
<a name="l00022"></a>00022  function oci_connect($a) {
<a name="l00023"></a>00023   <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00024"></a>00024  }
<a name="l00025"></a>00025 }
<a name="l00026"></a>00026 
<a name="l00027"></a>00027 <span class="keywordflow">if</span>(!function_exists(<span class="stringliteral">&quot;oci_error&quot;</span>)) {
<a name="l00028"></a>00028  function oci_error($a) {
<a name="l00029"></a>00029   <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00030"></a>00030  }
<a name="l00031"></a>00031 }
<a name="l00032"></a>00032 
<a name="l00033"></a>00033 <span class="keywordflow">if</span>(!function_exists(<span class="stringliteral">&quot;oci_commit&quot;</span>)) {
<a name="l00034"></a>00034  function oci_commit($a) {
<a name="l00035"></a>00035   <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00036"></a>00036  }
<a name="l00037"></a>00037 }
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 <span class="keywordflow">if</span>(!function_exists(<span class="stringliteral">&quot;oci_rollback&quot;</span>)) {
<a name="l00040"></a>00040  function oci_rollback($a) {
<a name="l00041"></a>00041   <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00042"></a>00042  }
<a name="l00043"></a>00043 }
<a name="l00044"></a>00044 
<a name="l00045"></a>00045 <span class="keywordflow">if</span>(!function_exists(<span class="stringliteral">&quot;oci_close&quot;</span>)) {
<a name="l00046"></a>00046  function oci_close($a) {
<a name="l00047"></a>00047   <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00048"></a>00048  }
<a name="l00049"></a>00049 }
<a name="l00050"></a>00050 
<a name="l00051"></a>00051 
<a name="l00373"></a><a class="code" href="class_c_m_oracle.html">00373</a> <span class="keyword">class </span><a class="code" href="class_c_m_oracle.html" title="Oracle Database connectivity.">CMOracle</a> <span class="keyword">extends</span> <a class="code" href="class_c_m_error.html" title="Error handling as a stand-alone or for classes vis inheritance.">CMError</a> implements <a class="code" href="interface_c_m_database_protocol.html" title="All database connectivity classes implement this interface.">CMDatabaseProtocol</a> {
<a name="l00374"></a>00374  
<a name="l00380"></a><a class="code" href="class_c_m_oracle.html#a9e2d53558e7b299d52b25c13d310d7e0">00380</a>  <span class="keyword">public</span> <span class="keyword">static</span> function <a class="code" href="class_c_m_oracle.html#a9e2d53558e7b299d52b25c13d310d7e0" title="The version of this class.">Version</a>() {
<a name="l00381"></a>00381   <span class="keywordflow">return</span> <span class="stringliteral">&quot;1.0&quot;</span>;
<a name="l00382"></a>00382  }
<a name="l00383"></a>00383  
<a name="l00389"></a><a class="code" href="class_c_m_oracle.html#ab51e04ce58ff27601a503f46d611b7e6">00389</a>  <span class="keyword">public</span> <span class="keyword">static</span> function <a class="code" href="class_c_m_oracle.html#ab51e04ce58ff27601a503f46d611b7e6" title="The version this class was introduced to the library.">Since</a>() {
<a name="l00390"></a>00390   <span class="keywordflow">return</span> <span class="stringliteral">&quot;1.0&quot;</span>;
<a name="l00391"></a>00391  }
<a name="l00392"></a>00392  
<a name="l00400"></a><a class="code" href="class_c_m_oracle.html#a69423cb24968e09a427084bd5f1191d3">00400</a>  <span class="keyword">private</span> <a class="code" href="class_c_m_oracle.html#a69423cb24968e09a427084bd5f1191d3" title="Internal auto commit flag.">$autoCommit</a> = <span class="keyword">true</span>;
<a name="l00401"></a>00401  
<a name="l00405"></a><a class="code" href="class_c_m_oracle.html#acc1e62674bb7200ea73767c19dc1344d">00405</a>  <span class="keyword">private</span> <a class="code" href="class_c_m_oracle.html#acc1e62674bb7200ea73767c19dc1344d" title="Internal database handle.">$dbh</a> = <span class="keyword">false</span>;
<a name="l00406"></a>00406  
<a name="l00446"></a><a class="code" href="class_c_m_oracle.html#a722d99066fe9d4d3dee817816ca23cdf">00446</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_oracle.html#a722d99066fe9d4d3dee817816ca23cdf" title="Connect to a database.">CMOracle</a>($uri, $a = <span class="keyword">false</span>) {
<a name="l00447"></a>00447   <span class="comment">// dissect the URI</span>
<a name="l00448"></a>00448   $v = parse_url($uri);
<a name="l00449"></a>00449   $v[<span class="stringliteral">&#39;db&#39;</span>] = basename($v[<span class="stringliteral">&#39;path&#39;</span>]);
<a name="l00450"></a>00450   
<a name="l00451"></a>00451   <span class="comment">// make sure the scheme is valid</span>
<a name="l00452"></a>00452   <span class="keywordflow">if</span>($v[<span class="stringliteral">&#39;scheme&#39;</span>] != <span class="stringliteral">&#39;oracle&#39;</span>) {
<a name="l00453"></a>00453    $this-&gt;<a class="code" href="class_c_m_error.html#a94a6cd26c794c35133502471eca8469e" title="Throw a Error level message.">throwError</a>(<span class="stringliteral">&quot;Unsupported driver &#39;{$v[&#39;scheme&#39;]}&#39;&quot;</span>);
<a name="l00454"></a>00454    <span class="keywordflow">return</span> $this;
<a name="l00455"></a>00455   }
<a name="l00456"></a>00456   
<a name="l00457"></a>00457   <span class="comment">// server options</span>
<a name="l00458"></a>00458   <span class="keywordflow">if</span>(!isset($a[<span class="stringliteral">&#39;LD_LIBRARY_PATH&#39;</span>]))
<a name="l00459"></a>00459    $a[<span class="stringliteral">&#39;LD_LIBRARY_PATH&#39;</span>] = <span class="stringliteral">&quot;$a[ORACLE_HOME]/lib&quot;</span>;
<a name="l00460"></a>00460 
<a name="l00461"></a>00461   <span class="comment">// environment variables</span>
<a name="l00462"></a>00462   <span class="keywordflow">if</span>(isset($v[<span class="stringliteral">&#39;db&#39;</span>]))
<a name="l00463"></a>00463    PutEnv(<span class="stringliteral">&quot;ORACLE_SID=$v[db]&quot;</span>);
<a name="l00464"></a>00464   <span class="keywordflow">if</span>(isset($a[<span class="stringliteral">&#39;ORACLE_HOME&#39;</span>]))
<a name="l00465"></a>00465    PutEnv(<span class="stringliteral">&quot;ORACLE_HOME=$a[ORACLE_HOME]&quot;</span>);
<a name="l00466"></a>00466   <span class="keywordflow">if</span>(isset($a[<span class="stringliteral">&#39;LD_LIBRARY_PATH&#39;</span>]))
<a name="l00467"></a>00467    PutEnv(<span class="stringliteral">&quot;LD_LIBRARY_PATH=$a[LD_LIBRARY_PATH]&quot;</span>);
<a name="l00468"></a>00468   
<a name="l00469"></a>00469   <span class="comment">// attempt to connect</span>
<a name="l00470"></a>00470   $this-&gt;dbh = oci_connect($v[<span class="stringliteral">&#39;user&#39;</span>], $v[<span class="stringliteral">&#39;pass&#39;</span>], $v[<span class="stringliteral">&#39;host&#39;</span>] . <span class="charliteral">&#39;/&#39;</span> . $v[<span class="stringliteral">&#39;db&#39;</span>]);
<a name="l00471"></a>00471   <span class="keywordflow">if</span>(!$this-&gt;dbh) {
<a name="l00472"></a>00472    $this-&gt;<a class="code" href="class_c_m_error.html#a94a6cd26c794c35133502471eca8469e" title="Throw a Error level message.">throwError</a>(oci_error());
<a name="l00473"></a>00473    <span class="keywordflow">return</span> $this;
<a name="l00474"></a>00474   }
<a name="l00475"></a>00475  }
<a name="l00476"></a>00476  
<a name="l00490"></a><a class="code" href="class_c_m_oracle.html#a4ced4e9cc5497c475c2cd1a03318f45a">00490</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_oracle.html#a4ced4e9cc5497c475c2cd1a03318f45a" title="Perform a query on the database that returns a handle to iterate the results.">query</a>($sql, $values = <span class="keyword">false</span>, $a = <span class="keyword">false</span>) {
<a name="l00491"></a>00491   $sql = $this-&gt;<a class="code" href="class_c_m_oracle.html#a08895ad5ecec3e9850ebe052b020d928" title="Use internally by query() and insert() for substituting values.">bindValues</a>($sql, $values);
<a name="l00492"></a>00492   
<a name="l00493"></a>00493   <span class="keywordflow">if</span>($a !== <span class="keyword">false</span> &amp;&amp; in_array(<span class="stringliteral">&#39;print&#39;</span>, $a))
<a name="l00494"></a>00494    echo $sql;
<a name="l00495"></a>00495   
<a name="l00496"></a>00496   $stid = oci_parse($this-&gt;dbh, $sql);
<a name="l00497"></a>00497   $success = <span class="keyword">false</span>;
<a name="l00498"></a>00498   <span class="keywordflow">if</span>($this-&gt;autoCommit)
<a name="l00499"></a>00499    $success = oci_execute($stid);
<a name="l00500"></a>00500   <span class="keywordflow">else</span> $success = oci_execute($stid, OCI_NO_AUTO_COMMIT);
<a name="l00501"></a>00501   
<a name="l00502"></a>00502   <span class="keywordflow">if</span>(!$success)
<a name="l00503"></a>00503    $this-&gt;<a class="code" href="class_c_m_error.html#a6d110c63a1c5103df7979612ed5209d3" title="Throw a Warning level message.">throwWarning</a>(<span class="stringliteral">&quot;Query failed&quot;</span>, array(<span class="stringliteral">&#39;sql&#39;</span> =&gt; $sql));
<a name="l00504"></a>00504   
<a name="l00505"></a>00505   <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="class_c_m_oracle_query.html" title="Oracle database query handler.">CMOracleQuery</a>($stid, $a);
<a name="l00506"></a>00506  }
<a name="l00507"></a>00507  
<a name="l00519"></a><a class="code" href="class_c_m_oracle.html#a13148537025768f2373012227785c540">00519</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_oracle.html#a13148537025768f2373012227785c540" title="Perform a query on the database that does not return a handle.">execute</a>($sql, $values = <span class="keyword">false</span>, $a = <span class="keyword">false</span>) {
<a name="l00520"></a>00520   $q = $this-&gt;<a class="code" href="class_c_m_oracle.html#a4ced4e9cc5497c475c2cd1a03318f45a" title="Perform a query on the database that returns a handle to iterate the results.">query</a>($sql, $values, $a);
<a name="l00521"></a>00521   <span class="keywordflow">return</span> $q-&gt;success();
<a name="l00522"></a>00522  }
<a name="l00523"></a>00523  
<a name="l00539"></a><a class="code" href="class_c_m_oracle.html#a08895ad5ecec3e9850ebe052b020d928">00539</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_oracle.html#a08895ad5ecec3e9850ebe052b020d928" title="Use internally by query() and insert() for substituting values.">bindValues</a>($sql, $values = <span class="keyword">false</span>) {
<a name="l00540"></a>00540   <span class="keywordflow">if</span>(is_array($values)) {
<a name="l00541"></a>00541    $parts = explode(<span class="charliteral">&#39;?&#39;</span>, $sql);
<a name="l00542"></a>00542    $new_sql = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00543"></a>00543    <span class="keywordflow">for</span>($i = 0; $i &lt; count($parts) - 1; ++$i) {
<a name="l00544"></a>00544     <span class="comment">// if its a CMConstant we don&#39;t encapsulate it</span>
<a name="l00545"></a>00545     <span class="keywordflow">if</span>($values[$i] instanceof <a class="code" href="class_c_m_constant.html" title="A container for value that need not be modified or encapsulated.">CMConstant</a> || $values[$i] instanceof <a class="code" href="class_c_m_decimal.html" title="Handling exact values.">CMDecimal</a>)
<a name="l00546"></a>00546      $new_sql .= $parts[$i] . $values[$i];
<a name="l00547"></a>00547     <span class="keywordflow">else</span>
<a name="l00548"></a>00548      $new_sql .= $parts[$i] . <span class="stringliteral">&quot;&#39;&quot;</span> . str_replace(<span class="stringliteral">&quot;&#39;&quot;</span>, <span class="stringliteral">&quot;&#39;&#39;&quot;</span>, $values[$i]) . <span class="stringliteral">&quot;&#39;&quot;</span>;
<a name="l00549"></a>00549    }
<a name="l00550"></a>00550    $sql = $new_sql . $parts[count($parts) - 1];
<a name="l00551"></a>00551   } elseif($values !== <span class="keyword">false</span>) {
<a name="l00552"></a>00552    <span class="comment">// if its a CMConstant we don&#39;t encapsulate it</span>
<a name="l00553"></a>00553    <span class="keywordflow">if</span>($values instanceof <a class="code" href="class_c_m_constant.html" title="A container for value that need not be modified or encapsulated.">CMConstant</a> || $values instanceof <a class="code" href="class_c_m_decimal.html" title="Handling exact values.">CMDecimal</a>)
<a name="l00554"></a>00554     $sql = str_replace(<span class="charliteral">&#39;?&#39;</span>, $values, $sql);
<a name="l00555"></a>00555    <span class="keywordflow">else</span>
<a name="l00556"></a>00556     $sql = str_replace(<span class="charliteral">&#39;?&#39;</span>, <span class="stringliteral">&quot;&#39;&quot;</span> . str_replace(<span class="stringliteral">&quot;&#39;&quot;</span>, <span class="stringliteral">&quot;&#39;&#39;&quot;</span>, $values) . <span class="stringliteral">&quot;&#39;&quot;</span>, $sql);
<a name="l00557"></a>00557   }
<a name="l00558"></a>00558    
<a name="l00559"></a>00559   <span class="keywordflow">return</span> $sql;
<a name="l00560"></a>00560  }
<a name="l00561"></a>00561  
<a name="l00585"></a><a class="code" href="class_c_m_oracle.html#a0f4b4455d44a47a695e4c6cf96488242">00585</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_oracle.html#a0f4b4455d44a47a695e4c6cf96488242" title="INSERT statement">insert</a>($name, $kv = <span class="keyword">false</span>, $a = <span class="keyword">false</span>) {
<a name="l00586"></a>00586   $sql = <span class="stringliteral">&quot;insert into $name (&quot;</span> . implode(<span class="charliteral">&#39;,&#39;</span>, array_keys($kv)) . <span class="stringliteral">&quot;) values (&quot;</span>;
<a name="l00587"></a>00587   $first = <span class="keyword">true</span>;
<a name="l00588"></a>00588   <span class="keywordflow">foreach</span>($kv as $k =&gt; $v) {
<a name="l00589"></a>00589    <span class="keywordflow">if</span>(!$first)
<a name="l00590"></a>00590     $sql .= <span class="stringliteral">&quot;,&quot;</span>;
<a name="l00591"></a>00591    
<a name="l00592"></a>00592    <span class="comment">// if its a CMConstant we don&#39;t encapsulate it</span>
<a name="l00593"></a>00593    <span class="keywordflow">if</span>($v instanceof <a class="code" href="class_c_m_constant.html" title="A container for value that need not be modified or encapsulated.">CMConstant</a> || $v instanceof <a class="code" href="class_c_m_decimal.html" title="Handling exact values.">CMDecimal</a>)
<a name="l00594"></a>00594     $sql .= $v;
<a name="l00595"></a>00595    <span class="keywordflow">else</span>
<a name="l00596"></a>00596     $sql .= <span class="stringliteral">&quot;&#39;&quot;</span> . str_replace(<span class="stringliteral">&quot;&#39;&quot;</span>, <span class="stringliteral">&quot;&#39;&#39;&quot;</span>, $v) . <span class="stringliteral">&quot;&#39;&quot;</span>;
<a name="l00597"></a>00597     
<a name="l00598"></a>00598    $first = <span class="keyword">false</span>;
<a name="l00599"></a>00599   }
<a name="l00600"></a>00600   
<a name="l00601"></a>00601   $success = $this-&gt;<a class="code" href="class_c_m_oracle.html#a4ced4e9cc5497c475c2cd1a03318f45a" title="Perform a query on the database that returns a handle to iterate the results.">query</a>(<span class="stringliteral">&quot;$sql)&quot;</span>)-&gt;success();
<a name="l00602"></a>00602   <span class="keywordflow">if</span>(!$success)
<a name="l00603"></a>00603    $this-&gt;<a class="code" href="class_c_m_error.html#a6d110c63a1c5103df7979612ed5209d3" title="Throw a Warning level message.">throwWarning</a>(<span class="stringliteral">&quot;Query failed&quot;</span>, array(<span class="stringliteral">&#39;sql&#39;</span> =&gt; <span class="stringliteral">&quot;$sql)&quot;</span>));
<a name="l00604"></a>00604   
<a name="l00605"></a>00605   <span class="keywordflow">return</span> $success;
<a name="l00606"></a>00606  }
<a name="l00607"></a>00607  
<a name="l00613"></a><a class="code" href="class_c_m_oracle.html#a36b890fb5812fc1247b8afe7d56e72ea">00613</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_oracle.html#a36b890fb5812fc1247b8afe7d56e72ea" title="Fetch the list of tables in the active database.">getTableNames</a>($schema = <span class="keyword">false</span>) {
<a name="l00614"></a>00614   <span class="keywordflow">return</span> $this-&gt;<a class="code" href="class_c_m_oracle.html#a4ced4e9cc5497c475c2cd1a03318f45a" title="Perform a query on the database that returns a handle to iterate the results.">query</a>(<span class="stringliteral">&#39;select table_name from user_tables&#39;</span>)-&gt;fetchAll(<span class="stringliteral">&#39;line&#39;</span>, <span class="stringliteral">&#39;vertical&#39;</span>);
<a name="l00615"></a>00615  }
<a name="l00616"></a>00616  
<a name="l00622"></a><a class="code" href="class_c_m_oracle.html#ae7cdaa744d52a1eb0103e377023ca528">00622</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_oracle.html#ae7cdaa744d52a1eb0103e377023ca528" title="Returns true or false for the active database.">tableExists</a>($table) {
<a name="l00623"></a>00623   <span class="keywordflow">return</span> in_array($table, $this-&gt;<a class="code" href="class_c_m_oracle.html#a36b890fb5812fc1247b8afe7d56e72ea" title="Fetch the list of tables in the active database.">getTableNames</a>());
<a name="l00624"></a>00624  }
<a name="l00625"></a>00625  
<a name="l00631"></a><a class="code" href="class_c_m_oracle.html#aea9c1153e0e0fc135f8d513263bf9201">00631</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_oracle.html#aea9c1153e0e0fc135f8d513263bf9201" title="Not supported.">getDatabaseNames</a>() {
<a name="l00632"></a>00632   <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00633"></a>00633  }
<a name="l00634"></a>00634 
<a name="l00640"></a><a class="code" href="class_c_m_oracle.html#a7cf4f2839a152f2c11f5893c640c19dd">00640</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_oracle.html#a7cf4f2839a152f2c11f5893c640c19dd" title="Not supported.">getSchemaNames</a>() {
<a name="l00641"></a>00641   <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00642"></a>00642  }
<a name="l00643"></a>00643  
<a name="l00656"></a><a class="code" href="class_c_m_oracle.html#aa45cf2b82a91150a11cd11fa0bf2847c">00656</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_oracle.html#aa45cf2b82a91150a11cd11fa0bf2847c" title="Class methods available to this query handle.">availableMethods</a>() {
<a name="l00657"></a>00657   <span class="keywordflow">return</span> array(<span class="stringliteral">&#39;commit&#39;</span>, <span class="stringliteral">&#39;delete&#39;</span>, <span class="stringliteral">&#39;disconnect&#39;</span>, <span class="stringliteral">&#39;engine&#39;</span>, <span class="stringliteral">&#39;eraseTable&#39;</span>, <span class="stringliteral">&#39;escapeString&#39;</span>,
<a name="l00658"></a>00658       <span class="stringliteral">&#39;execute&#39;</span>, <span class="stringliteral">&#39;getDatabaseNames&#39;</span>, <span class="stringliteral">&#39;getSchemaNames&#39;</span>, <span class="stringliteral">&#39;getTableNames&#39;</span>, <span class="stringliteral">&#39;insert&#39;</span>,
<a name="l00659"></a>00659       <span class="stringliteral">&#39;isConnected&#39;</span>, <span class="stringliteral">&#39;query&#39;</span>, <span class="stringliteral">&#39;rollback&#39;</span>, <span class="stringliteral">&#39;setAutoCommit&#39;</span>, <span class="stringliteral">&#39;tableExists&#39;</span>,
<a name="l00660"></a>00660       <span class="stringliteral">&#39;truncateTable&#39;</span>, <span class="stringliteral">&#39;update&#39;</span>, <span class="stringliteral">&#39;getAutoCommit&#39;</span>);
<a name="l00661"></a>00661  }
<a name="l00662"></a>00662  
<a name="l00668"></a><a class="code" href="class_c_m_oracle.html#af160f7fbbf281d018ae3162521b8267d">00668</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_oracle.html#af160f7fbbf281d018ae3162521b8267d" title="Check if the database connection is still active.">isConnected</a>() {
<a name="l00669"></a>00669   <span class="keywordflow">return</span> $this-&gt;dbh !== <span class="keyword">false</span>;
<a name="l00670"></a>00670  }
<a name="l00671"></a>00671  
<a name="l00677"></a><a class="code" href="class_c_m_oracle.html#abe175fcf658475bc56e9d6fa02bc88ec">00677</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_oracle.html#abe175fcf658475bc56e9d6fa02bc88ec" title="Disconnect database handle.">disconnect</a>() {
<a name="l00678"></a>00678   <span class="keywordflow">if</span>($this-&gt;dbh !== <span class="keyword">false</span>)
<a name="l00679"></a>00679    oci_close($this-&gt;dbh);
<a name="l00680"></a>00680   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00681"></a>00681  }
<a name="l00682"></a>00682  
<a name="l00688"></a><a class="code" href="class_c_m_oracle.html#a8147e0a0a8e607106004e2571195e01c">00688</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_oracle.html#a8147e0a0a8e607106004e2571195e01c" title="The name of the database product.">engine</a>() {
<a name="l00689"></a>00689   <span class="keywordflow">return</span> <span class="stringliteral">&quot;Oracle&quot;</span>;
<a name="l00690"></a>00690  }
<a name="l00691"></a>00691  
<a name="l00701"></a><a class="code" href="class_c_m_oracle.html#af5674c27d4a92f6228565010eacbb9cb">00701</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_oracle.html#af5674c27d4a92f6228565010eacbb9cb" title="COMMIT transaction.">commit</a>() {
<a name="l00702"></a>00702   <span class="keywordflow">if</span>($this-&gt;dbh === <span class="keyword">false</span>)
<a name="l00703"></a>00703    <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00704"></a>00704   <span class="keywordflow">return</span> oci_commit($this-&gt;dbh);
<a name="l00705"></a>00705  }
<a name="l00706"></a>00706 
<a name="l00716"></a><a class="code" href="class_c_m_oracle.html#afa549adf79e3f8c09fe8f903dd5fbfa7">00716</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_oracle.html#afa549adf79e3f8c09fe8f903dd5fbfa7" title="ROLLBACK transaction.">rollback</a>() {
<a name="l00717"></a>00717   <span class="keywordflow">if</span>($this-&gt;dbh === <span class="keyword">false</span>)
<a name="l00718"></a>00718    <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00719"></a>00719   <span class="keywordflow">return</span> oci_rollback($this-&gt;dbh);
<a name="l00720"></a>00720  }
<a name="l00721"></a>00721 
<a name="l00733"></a><a class="code" href="class_c_m_oracle.html#af569120fcd4d04f33780d9c10daf144c">00733</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_oracle.html#af569120fcd4d04f33780d9c10daf144c" title="Turn autocommit on/off.">setAutoCommit</a>($mode = <span class="keyword">false</span>) {
<a name="l00734"></a>00734   $this-&gt;autoCommit = $mode;
<a name="l00735"></a>00735   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00736"></a>00736  }
<a name="l00737"></a>00737  
<a name="l00741"></a><a class="code" href="class_c_m_oracle.html#a7516ca30af0db3cdbf9a7739b48ce91d">00741</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_oracle.html#a7516ca30af0db3cdbf9a7739b48ce91d" title="Return the string value of this object.">__toString</a>() {
<a name="l00742"></a>00742   <span class="keywordflow">return</span> <span class="stringliteral">&quot;&lt;&quot;</span> . get_class($this) . <span class="stringliteral">&quot;&gt;&quot;</span>;
<a name="l00743"></a>00743  }
<a name="l00744"></a>00744  
<a name="l00761"></a><a class="code" href="class_c_m_oracle.html#a7e4edd82127e0c6a2f42158fdbb258d3">00761</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_oracle.html#a7e4edd82127e0c6a2f42158fdbb258d3" title="Erase (not truncate) a table.">eraseTable</a>($tableName) {
<a name="l00762"></a>00762   <span class="comment">// need a valid database handle</span>
<a name="l00763"></a>00763   <span class="keywordflow">if</span>($this-&gt;dbh === <span class="keyword">false</span>)
<a name="l00764"></a>00764    <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00765"></a>00765   
<a name="l00766"></a>00766   $q = $this-&gt;<a class="code" href="class_c_m_oracle.html#a4ced4e9cc5497c475c2cd1a03318f45a" title="Perform a query on the database that returns a handle to iterate the results.">query</a>(<span class="stringliteral">&quot;DELETE FROM $tableName WHERE 1&quot;</span>);
<a name="l00767"></a>00767   <span class="keywordflow">return</span> $q-&gt;success();
<a name="l00768"></a>00768  }
<a name="l00769"></a>00769  
<a name="l00782"></a><a class="code" href="class_c_m_oracle.html#aff013143f73f33653e2f60fecbde00cb">00782</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_oracle.html#aff013143f73f33653e2f60fecbde00cb" title="TRUNCATE table.">truncateTable</a>($tableName) {
<a name="l00783"></a>00783   <span class="comment">// need a valid database handle</span>
<a name="l00784"></a>00784   <span class="keywordflow">if</span>($this-&gt;dbh === <span class="keyword">false</span>)
<a name="l00785"></a>00785    <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00786"></a>00786   
<a name="l00787"></a>00787   $q = $this-&gt;<a class="code" href="class_c_m_oracle.html#a4ced4e9cc5497c475c2cd1a03318f45a" title="Perform a query on the database that returns a handle to iterate the results.">query</a>(<span class="stringliteral">&quot;TRUNCATE TABLE $tableName&quot;</span>);
<a name="l00788"></a>00788   <span class="keywordflow">return</span> $q-&gt;success();
<a name="l00789"></a>00789  }
<a name="l00790"></a>00790  
<a name="l00801"></a><a class="code" href="class_c_m_oracle.html#ac32a7f2a2c349c061f600bc0ac2fec86">00801</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_oracle.html#ac32a7f2a2c349c061f600bc0ac2fec86" title="UPDATE statement.">update</a>($tableName, $newvalues, $criteria = <span class="keyword">false</span>, $a = <span class="keyword">false</span>) {
<a name="l00802"></a>00802   <span class="comment">// $a must be an array</span>
<a name="l00803"></a>00803   <span class="keywordflow">if</span>(!is_array($a))
<a name="l00804"></a>00804    $a = array();
<a name="l00805"></a>00805   
<a name="l00806"></a>00806   $sql = <span class="stringliteral">&quot;UPDATE `$tableName` SET &quot;</span>;
<a name="l00807"></a>00807   $first = <span class="keyword">true</span>;
<a name="l00808"></a>00808   <span class="keywordflow">foreach</span>($newvalues as $k =&gt; $v) {
<a name="l00809"></a>00809    <span class="keywordflow">if</span>(!$first) $sql .= <span class="stringliteral">&quot;,&quot;</span>;
<a name="l00810"></a>00810    
<a name="l00811"></a>00811    <span class="comment">// if its a CMConstant we don&#39;t encapsulate it</span>
<a name="l00812"></a>00812    <span class="keywordflow">if</span>($v instanceof <a class="code" href="class_c_m_constant.html" title="A container for value that need not be modified or encapsulated.">CMConstant</a> || $v instanceof <a class="code" href="class_c_m_decimal.html" title="Handling exact values.">CMDecimal</a>)
<a name="l00813"></a>00813     $sql .= <span class="stringliteral">&quot;$k=$v&quot;</span>;
<a name="l00814"></a>00814    <span class="keywordflow">else</span>
<a name="l00815"></a>00815     $sql .= <span class="stringliteral">&quot;$k=&#39;&quot;</span> . str_replace(<span class="stringliteral">&quot;&#39;&quot;</span>, <span class="stringliteral">&quot;&#39;&#39;&quot;</span>, $v) . <span class="stringliteral">&quot;&#39;&quot;</span>;
<a name="l00816"></a>00816    
<a name="l00817"></a>00817    $first = <span class="keyword">false</span>;
<a name="l00818"></a>00818   }
<a name="l00819"></a>00819   
<a name="l00820"></a>00820   <span class="comment">// add WHERE clause</span>
<a name="l00821"></a>00821   <span class="keywordflow">if</span>($criteria !== <span class="keyword">false</span>) {
<a name="l00822"></a>00822    $sql .= <span class="stringliteral">&quot; WHERE &quot;</span>;
<a name="l00823"></a>00823    $first = <span class="keyword">true</span>;
<a name="l00824"></a>00824    <span class="keywordflow">foreach</span>($criteria as $k =&gt; $v) {
<a name="l00825"></a>00825     <span class="keywordflow">if</span>(!$first) $sql .= <span class="stringliteral">&quot; AND &quot;</span>;
<a name="l00826"></a>00826     
<a name="l00827"></a>00827     <span class="comment">// if its a CMConstant we don&#39;t encapsulate it</span>
<a name="l00828"></a>00828     <span class="keywordflow">if</span>($v instanceof <a class="code" href="class_c_m_constant.html" title="A container for value that need not be modified or encapsulated.">CMConstant</a> || $v instanceof <a class="code" href="class_c_m_decimal.html" title="Handling exact values.">CMDecimal</a>)
<a name="l00829"></a>00829      $sql .= <span class="stringliteral">&quot;$k=$v&quot;</span>;
<a name="l00830"></a>00830     <span class="keywordflow">else</span>
<a name="l00831"></a>00831      $sql .= <span class="stringliteral">&quot;$k=&#39;&quot;</span> . str_replace(<span class="stringliteral">&quot;&#39;&quot;</span>, <span class="stringliteral">&quot;&#39;&#39;&quot;</span>, $v) . <span class="stringliteral">&quot;&#39;&quot;</span>;
<a name="l00832"></a>00832     
<a name="l00833"></a>00833     $first = <span class="keyword">false</span>;
<a name="l00834"></a>00834    }
<a name="l00835"></a>00835   }
<a name="l00836"></a>00836   
<a name="l00837"></a>00837   <span class="keywordflow">if</span>(isset($a[<span class="stringliteral">&#39;print&#39;</span>]))
<a name="l00838"></a>00838    echo $sql;
<a name="l00839"></a>00839   
<a name="l00840"></a>00840   $q = $this-&gt;<a class="code" href="class_c_m_oracle.html#a4ced4e9cc5497c475c2cd1a03318f45a" title="Perform a query on the database that returns a handle to iterate the results.">query</a>($sql, <span class="keyword">false</span>, $a);
<a name="l00841"></a>00841   <span class="keywordflow">if</span>($q-&gt;success())
<a name="l00842"></a>00842    <span class="keywordflow">return</span> $q-&gt;affectedRows();
<a name="l00843"></a>00843   <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00844"></a>00844  }
<a name="l00845"></a>00845  
<a name="l00855"></a><a class="code" href="class_c_m_oracle.html#a2415ba06f043f104ed33b9571f200fc8">00855</a>  <span class="keyword">public</span> function <span class="keyword">delete</span>($tableName, $criteria = <span class="keyword">false</span>, $a = <span class="keyword">false</span>) {
<a name="l00856"></a>00856   <span class="comment">// $a must be an array</span>
<a name="l00857"></a>00857   <span class="keywordflow">if</span>(!is_array($a))
<a name="l00858"></a>00858    $a = array();
<a name="l00859"></a>00859   
<a name="l00860"></a>00860   $sql = <span class="stringliteral">&quot;DELETE FROM `$tableName`&quot;</span>;
<a name="l00861"></a>00861   
<a name="l00862"></a>00862   <span class="comment">// add WHERE clause</span>
<a name="l00863"></a>00863   <span class="keywordflow">if</span>($criteria !== <span class="keyword">false</span>) {
<a name="l00864"></a>00864    $sql .= <span class="stringliteral">&quot; WHERE &quot;</span>;
<a name="l00865"></a>00865    $first = <span class="keyword">true</span>;
<a name="l00866"></a>00866    <span class="keywordflow">foreach</span>($criteria as $k =&gt; $v) {
<a name="l00867"></a>00867     <span class="keywordflow">if</span>(!$first) $sql .= <span class="stringliteral">&quot; AND &quot;</span>;
<a name="l00868"></a>00868     
<a name="l00869"></a>00869     <span class="comment">// if its a CMConstant we don&#39;t encapsulate it</span>
<a name="l00870"></a>00870     <span class="keywordflow">if</span>($v instanceof <a class="code" href="class_c_m_constant.html" title="A container for value that need not be modified or encapsulated.">CMConstant</a> || $v instanceof <a class="code" href="class_c_m_decimal.html" title="Handling exact values.">CMDecimal</a>)
<a name="l00871"></a>00871      $sql .= <span class="stringliteral">&quot;$k=$v&quot;</span>;
<a name="l00872"></a>00872     <span class="keywordflow">else</span>
<a name="l00873"></a>00873      $sql .= <span class="stringliteral">&quot;$k=&#39;&quot;</span> . str_replace(<span class="stringliteral">&quot;&#39;&quot;</span>, <span class="stringliteral">&quot;&#39;&#39;&quot;</span>, $v) . <span class="stringliteral">&quot;&#39;&quot;</span>;
<a name="l00874"></a>00874     
<a name="l00875"></a>00875     $first = <span class="keyword">false</span>;
<a name="l00876"></a>00876    }
<a name="l00877"></a>00877   }
<a name="l00878"></a>00878   
<a name="l00879"></a>00879   <span class="keywordflow">if</span>(isset($a[<span class="stringliteral">&#39;print&#39;</span>]))
<a name="l00880"></a>00880    echo $sql;
<a name="l00881"></a>00881   
<a name="l00882"></a>00882   $q = $this-&gt;<a class="code" href="class_c_m_oracle.html#a4ced4e9cc5497c475c2cd1a03318f45a" title="Perform a query on the database that returns a handle to iterate the results.">query</a>($sql, <span class="keyword">false</span>, $a);
<a name="l00883"></a>00883   <span class="keywordflow">if</span>($q-&gt;success())
<a name="l00884"></a>00884    <span class="keywordflow">return</span> $q-&gt;affectedRows();
<a name="l00885"></a>00885   <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00886"></a>00886  }
<a name="l00887"></a>00887  
<a name="l00894"></a><a class="code" href="class_c_m_oracle.html#a2d931763c47d46ab7c26ba4e69d969d7">00894</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_oracle.html#a2d931763c47d46ab7c26ba4e69d969d7" title="Escape a string based on the correct rules of the database engine.">escapeString</a>($str) {
<a name="l00895"></a>00895   <span class="keywordflow">return</span> str_replace(<span class="stringliteral">&quot;&#39;&quot;</span>, <span class="stringliteral">&quot;&#39;&#39;&quot;</span>, $str); 
<a name="l00896"></a>00896  }
<a name="l00897"></a>00897  
<a name="l00904"></a><a class="code" href="class_c_m_oracle.html#a7327ec53765f61a4a9d715133d2ea2db">00904</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_oracle.html#a7327ec53765f61a4a9d715133d2ea2db" title="Return the auto commit status.">getAutoCommit</a>() {
<a name="l00905"></a>00905   <span class="keywordflow">return</span> $this-&gt;autoCommit;
<a name="l00906"></a>00906  }
<a name="l00907"></a>00907  
<a name="l00917"></a><a class="code" href="class_c_m_oracle.html#a2c521548fb2e9d535673e11208bd5f6c">00917</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_oracle.html#a2c521548fb2e9d535673e11208bd5f6c" title="Escape an entity based on the correct rules of the database engine.">escapeEntity</a>($str) {
<a name="l00918"></a>00918   <span class="keywordflow">return</span> $str;
<a name="l00919"></a>00919  }
<a name="l00920"></a>00920  
<a name="l00927"></a><a class="code" href="class_c_m_oracle.html#a18a087f04157464ca9e96af805da4e8c">00927</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_oracle.html#a18a087f04157464ca9e96af805da4e8c" title="Describe a table.">describeTable</a>($tableName, $a = array()) {
<a name="l00928"></a>00928   <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00929"></a>00929  }
<a name="l00930"></a>00930  
<a name="l00946"></a><a class="code" href="class_c_m_oracle.html#ad3c2efe6828834aadd7cbe990e502645">00946</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_oracle.html#ad3c2efe6828834aadd7cbe990e502645" title="Load a SQL file into the current connection.">loadSQLFile</a>($path, $a = array()) {
<a name="l00947"></a>00947   <span class="comment">// prepare</span>
<a name="l00948"></a>00948   $f = fopen($path, <span class="stringliteral">&quot;r&quot;</span>);
<a name="l00949"></a>00949   <span class="keywordflow">if</span>(!$f)
<a name="l00950"></a>00950    <span class="keywordflow">return</span> $this-&gt;<a class="code" href="class_c_m_error.html#a94a6cd26c794c35133502471eca8469e" title="Throw a Error level message.">throwError</a>(<span class="stringliteral">&quot;Could not open input file $path&quot;</span>);
<a name="l00951"></a>00951   
<a name="l00952"></a>00952   <span class="comment">// read each SQL command</span>
<a name="l00953"></a>00953   $success = <span class="keyword">true</span>;
<a name="l00954"></a>00954   $sql = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00955"></a>00955   <span class="keywordflow">while</span>(<span class="keyword">true</span>) {
<a name="l00956"></a>00956    $c = fgetc($f);
<a name="l00957"></a>00957    
<a name="l00958"></a>00958    <span class="comment">// skip whitespace</span>
<a name="l00959"></a>00959    <span class="keywordflow">while</span>(<span class="keyword">true</span>) {
<a name="l00960"></a>00960     $c = fgetc($f);
<a name="l00961"></a>00961     <span class="keywordflow">if</span>(!ctype_space($c)) {
<a name="l00962"></a>00962      fseek($f, -1, SEEK_CUR);
<a name="l00963"></a>00963      <span class="keywordflow">break</span>;
<a name="l00964"></a>00964     }
<a name="l00965"></a>00965    }
<a name="l00966"></a>00966    
<a name="l00967"></a>00967    <span class="comment">// comment</span>
<a name="l00968"></a>00968    <span class="keywordflow">if</span>($c == <span class="charliteral">&#39;-&#39;</span>) {
<a name="l00969"></a>00969     <span class="keywordflow">if</span>(fgetc($f) == <span class="charliteral">&#39;-&#39;</span>) {
<a name="l00970"></a>00970      <span class="comment">// keep reading until the comment ends</span>
<a name="l00971"></a>00971      <span class="keywordflow">while</span>(<span class="keyword">true</span>) {
<a name="l00972"></a>00972       $c = fgetc($f);
<a name="l00973"></a>00973       <span class="keywordflow">if</span>($c == <span class="stringliteral">&quot;\n&quot;</span> || $c == <span class="stringliteral">&quot;\r&quot;</span> || feof($f))
<a name="l00974"></a>00974        <span class="keywordflow">break</span>;
<a name="l00975"></a>00975      }
<a name="l00976"></a>00976      <span class="keywordflow">continue</span>;
<a name="l00977"></a>00977     }
<a name="l00978"></a>00978     <span class="keywordflow">else</span>
<a name="l00979"></a>00979      fseek($f, -1, SEEK_CUR);
<a name="l00980"></a>00980    }
<a name="l00981"></a>00981    
<a name="l00982"></a>00982    <span class="comment">// reading SQL</span>
<a name="l00983"></a>00983    <span class="keywordflow">while</span>(<span class="keyword">true</span>) {
<a name="l00984"></a>00984     $c = fgetc($f);
<a name="l00985"></a>00985     <span class="keywordflow">if</span>($c == <span class="stringliteral">&quot;;&quot;</span> || feof($f)) {
<a name="l00986"></a>00986      $sql = trim($sql);
<a name="l00987"></a>00987      <span class="keywordflow">if</span>($sql != <span class="stringliteral">&quot;&quot;</span>)
<a name="l00988"></a>00988       $this-&gt;<a class="code" href="class_c_m_oracle.html#a4ced4e9cc5497c475c2cd1a03318f45a" title="Perform a query on the database that returns a handle to iterate the results.">query</a>($sql);
<a name="l00989"></a>00989       
<a name="l00990"></a>00990      <span class="comment">// reset</span>
<a name="l00991"></a>00991      $sql = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00992"></a>00992      <span class="keywordflow">break</span>;
<a name="l00993"></a>00993     }
<a name="l00994"></a>00994     $sql .= $c;
<a name="l00995"></a>00995    }
<a name="l00996"></a>00996    
<a name="l00997"></a>00997    <span class="keywordflow">if</span>(feof($f))
<a name="l00998"></a>00998     <span class="keywordflow">break</span>;
<a name="l00999"></a>00999   }
<a name="l01000"></a>01000   
<a name="l01001"></a>01001   <span class="keywordflow">return</span> $success;
<a name="l01002"></a>01002  }
<a name="l01003"></a>01003 
<a name="l01004"></a>01004 }
<a name="l01005"></a>01005 
<a name="l01006"></a>01006 ?&gt;
</pre></div></div>
<hr class="footer"/><address style="text-align: right;"><small>Generated by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
