<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>CMLIB: CMPostgreSQL.php Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    </ul>
  </div>
<h1>CMPostgreSQL.php</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00002"></a>00002 
<a name="l00003"></a>00003 include_once(<span class="stringliteral">&quot;CMDatabaseProtocol.php&quot;</span>);
<a name="l00004"></a>00004 include_once(<span class="stringliteral">&quot;CMPostgreSQLQuery.php&quot;</span>);
<a name="l00005"></a>00005 include_once(<span class="stringliteral">&quot;CMConstant.php&quot;</span>);
<a name="l00006"></a>00006 include_once(<span class="stringliteral">&quot;CMError.php&quot;</span>);
<a name="l00007"></a>00007 include_once(<span class="stringliteral">&quot;CMDecimal.php&quot;</span>);
<a name="l00008"></a>00008 
<a name="l00351"></a><a class="code" href="class_c_m_postgre_s_q_l.html">00351</a> <span class="keyword">class </span><a class="code" href="class_c_m_postgre_s_q_l.html" title="PostgreSQL connectivity class.">CMPostgreSQL</a> <span class="keyword">extends</span> <a class="code" href="class_c_m_error.html" title="Error handling as a stand-alone or for classes vis inheritance.">CMError</a> implements <a class="code" href="interface_c_m_database_protocol.html" title="All database connectivity classes implement this interface.">CMDatabaseProtocol</a> {
<a name="l00352"></a>00352  
<a name="l00358"></a><a class="code" href="class_c_m_postgre_s_q_l.html#a9e2d53558e7b299d52b25c13d310d7e0">00358</a>  <span class="keyword">public</span> <span class="keyword">static</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#a9e2d53558e7b299d52b25c13d310d7e0" title="The version of this class.">Version</a>() {
<a name="l00359"></a>00359   <span class="keywordflow">return</span> <span class="stringliteral">&quot;1.0&quot;</span>;
<a name="l00360"></a>00360  }
<a name="l00361"></a>00361  
<a name="l00367"></a><a class="code" href="class_c_m_postgre_s_q_l.html#ab51e04ce58ff27601a503f46d611b7e6">00367</a>  <span class="keyword">public</span> <span class="keyword">static</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#ab51e04ce58ff27601a503f46d611b7e6" title="The version this class was introduced to the library.">Since</a>() {
<a name="l00368"></a>00368   <span class="keywordflow">return</span> <span class="stringliteral">&quot;1.0&quot;</span>;
<a name="l00369"></a>00369  }
<a name="l00370"></a>00370  
<a name="l00377"></a><a class="code" href="class_c_m_postgre_s_q_l.html#a69423cb24968e09a427084bd5f1191d3">00377</a>  <span class="keyword">private</span> <a class="code" href="class_c_m_postgre_s_q_l.html#a69423cb24968e09a427084bd5f1191d3" title="Internal auto commit flag.">$autoCommit</a> = <span class="keyword">true</span>;
<a name="l00378"></a>00378  
<a name="l00382"></a><a class="code" href="class_c_m_postgre_s_q_l.html#acc1e62674bb7200ea73767c19dc1344d">00382</a>  <span class="keyword">private</span> <a class="code" href="class_c_m_postgre_s_q_l.html#acc1e62674bb7200ea73767c19dc1344d" title="Internal database handle.">$dbh</a> = <span class="keyword">false</span>;
<a name="l00383"></a>00383  
<a name="l00398"></a><a class="code" href="class_c_m_postgre_s_q_l.html#a5bb2d2117b6f5d3646338ebf17d65d17">00398</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#a5bb2d2117b6f5d3646338ebf17d65d17" title="Connect to a PostgreSQL database.">CMPostgreSQL</a>($uri, $a = <span class="keyword">false</span>) {
<a name="l00399"></a>00399   <span class="comment">// dissect the URI</span>
<a name="l00400"></a>00400   $v = parse_url($uri);
<a name="l00401"></a>00401   $v[<span class="stringliteral">&#39;db&#39;</span>] = basename($v[<span class="stringliteral">&#39;path&#39;</span>]);
<a name="l00402"></a>00402   
<a name="l00403"></a>00403   <span class="comment">// make sure the scheme is valid</span>
<a name="l00404"></a>00404   <span class="keywordflow">if</span>($v[<span class="stringliteral">&#39;scheme&#39;</span>] != <span class="stringliteral">&#39;postgres&#39;</span> &amp;&amp; $v[<span class="stringliteral">&#39;scheme&#39;</span>] != <span class="stringliteral">&#39;postgresql&#39;</span>) {
<a name="l00405"></a>00405    $this-&gt;<a class="code" href="class_c_m_error.html#a94a6cd26c794c35133502471eca8469e" title="Throw a Error level message.">throwError</a>(<span class="stringliteral">&quot;Unsupported driver &#39;{$v[&#39;scheme&#39;]}&#39;&quot;</span>);
<a name="l00406"></a>00406    <span class="keywordflow">return</span> $this;
<a name="l00407"></a>00407   }
<a name="l00408"></a>00408   
<a name="l00409"></a>00409   <span class="comment">// suppress isset warnings and set defaults</span>
<a name="l00410"></a>00410   <span class="keywordflow">if</span>(!isset($v[<span class="stringliteral">&#39;host&#39;</span>]) || $v[<span class="stringliteral">&#39;host&#39;</span>] == <span class="stringliteral">&#39;localhost&#39;</span>)
<a name="l00411"></a>00411    $v[<span class="stringliteral">&#39;host&#39;</span>] = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00412"></a>00412   <span class="keywordflow">if</span>(!isset($v[<span class="stringliteral">&#39;port&#39;</span>]))
<a name="l00413"></a>00413    $v[<span class="stringliteral">&#39;port&#39;</span>] = 5432;
<a name="l00414"></a>00414   <span class="keywordflow">if</span>(!isset($v[<span class="stringliteral">&#39;db&#39;</span>]))
<a name="l00415"></a>00415    $v[<span class="stringliteral">&#39;db&#39;</span>] = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00416"></a>00416   <span class="keywordflow">if</span>(!isset($v[<span class="stringliteral">&#39;user&#39;</span>]))
<a name="l00417"></a>00417    $v[<span class="stringliteral">&#39;user&#39;</span>] = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00418"></a>00418   <span class="keywordflow">if</span>(!isset($v[<span class="stringliteral">&#39;pass&#39;</span>]))
<a name="l00419"></a>00419    $v[<span class="stringliteral">&#39;pass&#39;</span>] = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00420"></a>00420   
<a name="l00421"></a>00421   <span class="comment">// attempt to connect</span>
<a name="l00422"></a>00422   $connect_string = <span class="stringliteral">&quot;host=&#39;{$v[&#39;host&#39;]}&#39; port=&#39;{$v[&#39;port&#39;]}&#39; dbname=&#39;{$v[&#39;db&#39;]}&#39; user=&#39;{$v[&#39;user&#39;]}&#39; password=&#39;{$v[&#39;pass&#39;]}&#39;&quot;</span>;
<a name="l00423"></a>00423   $this-&gt;dbh = @pg_connect($connect_string);
<a name="l00424"></a>00424   <span class="keywordflow">if</span>(!$this-&gt;dbh) {
<a name="l00425"></a>00425    $this-&gt;<a class="code" href="class_c_m_error.html#a94a6cd26c794c35133502471eca8469e" title="Throw a Error level message.">throwError</a>(<span class="stringliteral">&quot;Could not connect to database.&quot;</span>);
<a name="l00426"></a>00426    <span class="keywordflow">return</span> $this;
<a name="l00427"></a>00427   }
<a name="l00428"></a>00428  }
<a name="l00429"></a>00429  
<a name="l00441"></a><a class="code" href="class_c_m_postgre_s_q_l.html#a4ced4e9cc5497c475c2cd1a03318f45a">00441</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#a4ced4e9cc5497c475c2cd1a03318f45a" title="Perform a query on the database that returns a handle to iterate the results.">query</a>($sql, $values = <span class="keyword">false</span>, $a = <span class="keyword">false</span>) {
<a name="l00442"></a>00442   <span class="comment">// $a must be an array</span>
<a name="l00443"></a>00443   <span class="keywordflow">if</span>(!is_array($a))
<a name="l00444"></a>00444    $a = array($a =&gt; <span class="keyword">true</span>);
<a name="l00445"></a>00445    
<a name="l00446"></a>00446   $sql = $this-&gt;<a class="code" href="class_c_m_postgre_s_q_l.html#a9510b8d39cd7053fe9cf02592f029766" title="Use internally by query() and insert() for substituting values.">bindValues</a>($sql, $values, $a);
<a name="l00447"></a>00447   
<a name="l00448"></a>00448   <span class="keywordflow">if</span>(isset($a[<span class="stringliteral">&#39;print&#39;</span>]))
<a name="l00449"></a>00449    echo <span class="stringliteral">&quot;$sql\n&quot;</span>;
<a name="l00450"></a>00450   
<a name="l00451"></a>00451   $q = @pg_query($this-&gt;dbh, $sql);
<a name="l00452"></a>00452   <span class="keywordflow">if</span>(!$q)
<a name="l00453"></a>00453    $this-&gt;<a class="code" href="class_c_m_error.html#a6d110c63a1c5103df7979612ed5209d3" title="Throw a Warning level message.">throwWarning</a>(<span class="stringliteral">&quot;Query failed&quot;</span>, array(<span class="stringliteral">&#39;sql&#39;</span> =&gt; $sql));
<a name="l00454"></a>00454   <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="class_c_m_postgre_s_q_l_query.html" title="PostgreSQL query handle.">CMPostgreSQLQuery</a>($q, $a);
<a name="l00455"></a>00455  }
<a name="l00456"></a>00456  
<a name="l00472"></a><a class="code" href="class_c_m_postgre_s_q_l.html#a9510b8d39cd7053fe9cf02592f029766">00472</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#a9510b8d39cd7053fe9cf02592f029766" title="Use internally by query() and insert() for substituting values.">bindValues</a>($sql, $values = <span class="keyword">false</span>, $a = <span class="keyword">false</span>) {
<a name="l00473"></a>00473   <span class="keywordflow">if</span>(is_array($values)) {
<a name="l00474"></a>00474    $parts = explode(<span class="charliteral">&#39;?&#39;</span>, $sql);
<a name="l00475"></a>00475    $new_sql = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00476"></a>00476    <span class="keywordflow">for</span>($i = 0; $i &lt; count($parts) - 1; ++$i) {
<a name="l00477"></a>00477     <span class="comment">// if its a CMConstant we don&#39;t encapsulate it</span>
<a name="l00478"></a>00478     <span class="keywordflow">if</span>($values[$i] instanceof <a class="code" href="class_c_m_constant.html" title="A container for value that need not be modified or encapsulated.">CMConstant</a> || $values[$i] instanceof <a class="code" href="class_c_m_decimal.html" title="Handling exact values.">CMDecimal</a>)
<a name="l00479"></a>00479      $new_sql .= $parts[$i] . $values[$i];
<a name="l00480"></a>00480     <span class="keywordflow">else</span>
<a name="l00481"></a>00481      $new_sql .= $parts[$i] . <span class="stringliteral">&quot;&#39;&quot;</span> . pg_escape_string($values[$i]) . <span class="stringliteral">&quot;&#39;&quot;</span>;
<a name="l00482"></a>00482    }
<a name="l00483"></a>00483    $sql = $new_sql . $parts[count($parts) - 1];
<a name="l00484"></a>00484   } elseif($values !== <span class="keyword">false</span>) {
<a name="l00485"></a>00485    <span class="comment">// if its a CMConstant we don&#39;t encapsulate it</span>
<a name="l00486"></a>00486    <span class="keywordflow">if</span>($values instanceof <a class="code" href="class_c_m_constant.html" title="A container for value that need not be modified or encapsulated.">CMConstant</a> || $values instanceof <a class="code" href="class_c_m_decimal.html" title="Handling exact values.">CMDecimal</a>)
<a name="l00487"></a>00487     $sql = str_replace(<span class="charliteral">&#39;?&#39;</span>, $values, $sql);
<a name="l00488"></a>00488    <span class="keywordflow">else</span>
<a name="l00489"></a>00489     $sql = str_replace(<span class="charliteral">&#39;?&#39;</span>, <span class="stringliteral">&quot;&#39;&quot;</span> . pg_escape_string($values) . <span class="stringliteral">&quot;&#39;&quot;</span>, $sql);
<a name="l00490"></a>00490   }
<a name="l00491"></a>00491    
<a name="l00492"></a>00492   <span class="keywordflow">return</span> $sql;
<a name="l00493"></a>00493  }
<a name="l00494"></a>00494  
<a name="l00507"></a><a class="code" href="class_c_m_postgre_s_q_l.html#a13148537025768f2373012227785c540">00507</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#a13148537025768f2373012227785c540" title="Perform a query on the database that does not return a handle.">execute</a>($sql, $values = <span class="keyword">false</span>, $a = <span class="keyword">false</span>) {
<a name="l00508"></a>00508   $q = $this-&gt;<a class="code" href="class_c_m_postgre_s_q_l.html#a4ced4e9cc5497c475c2cd1a03318f45a" title="Perform a query on the database that returns a handle to iterate the results.">query</a>($sql, $values, $a);
<a name="l00509"></a>00509   <span class="keywordflow">return</span> $q-&gt;success();
<a name="l00510"></a>00510  }
<a name="l00511"></a>00511  
<a name="l00521"></a><a class="code" href="class_c_m_postgre_s_q_l.html#a43b7a70e62a25caeb0b9d55c32423c16">00521</a>  <span class="keyword">private</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#a43b7a70e62a25caeb0b9d55c32423c16" title="Cast PostgreSQL safe type.">castSafeValue</a>($value, $col) {
<a name="l00522"></a>00522   <span class="comment">// work out the real data type</span>
<a name="l00523"></a>00523   $type = $col[<span class="stringliteral">&#39;data_type&#39;</span>];
<a name="l00524"></a>00524   <span class="keywordflow">if</span>($type == <span class="stringliteral">&#39;USER-DEFINED&#39;</span>)
<a name="l00525"></a>00525    $type = $col[<span class="stringliteral">&#39;udt_name&#39;</span>];
<a name="l00526"></a>00526   
<a name="l00527"></a>00527   <span class="comment">// date and time types to look out for</span>
<a name="l00528"></a>00528   <span class="keywordflow">if</span>(in_array($type, array(<span class="stringliteral">&#39;timestamp&#39;</span>, <span class="stringliteral">&#39;timestamp with time zone&#39;</span>, <span class="stringliteral">&#39;timestamp without time zone&#39;</span>)) &amp;&amp; trim($value) == <span class="stringliteral">&#39;&#39;</span>)
<a name="l00529"></a>00529    $value = NULL;
<a name="l00530"></a>00530   <span class="keywordflow">if</span>(in_array($type, array(<span class="stringliteral">&#39;date&#39;</span>, <span class="stringliteral">&#39;time&#39;</span>)) &amp;&amp; trim($value) == <span class="stringliteral">&#39;&#39;</span>)
<a name="l00531"></a>00531    $value = NULL;
<a name="l00532"></a>00532    
<a name="l00533"></a>00533   <span class="comment">// numerical types</span>
<a name="l00534"></a>00534   <span class="keywordflow">if</span>(substr($type, 0, 3) == <span class="stringliteral">&#39;int&#39;</span> &amp;&amp; trim($value) == <span class="stringliteral">&#39;&#39;</span>)
<a name="l00535"></a>00535    $value = NULL;
<a name="l00536"></a>00536    
<a name="l00537"></a>00537   <span class="comment">// array types</span>
<a name="l00538"></a>00538   <span class="keywordflow">if</span>($type == <span class="stringliteral">&#39;ARRAY&#39;</span>) {
<a name="l00539"></a>00539    <span class="keywordflow">if</span>(is_array($value))
<a name="l00540"></a>00540     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&#39;{&quot;</span> . implode(<span class="stringliteral">&quot;,&quot;</span>, $value) . <span class="stringliteral">&quot;}&#39;&quot;</span>;
<a name="l00541"></a>00541    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(@substr($value, 0, 1) == <span class="charliteral">&#39;{&#39;</span>)
<a name="l00542"></a>00542     <span class="comment">// we will assume this is the string form of the array</span>
<a name="l00543"></a>00543     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&#39;$value&#39;&quot;</span>;
<a name="l00544"></a>00544    
<a name="l00545"></a>00545    <span class="keywordflow">return</span> NULL;
<a name="l00546"></a>00546   }
<a name="l00547"></a>00547   
<a name="l00548"></a>00548   <span class="keywordflow">if</span>($value === NULL)
<a name="l00549"></a>00549    <span class="keywordflow">return</span> <span class="stringliteral">&quot;NULL&quot;</span>;
<a name="l00550"></a>00550   <span class="keywordflow">return</span> <span class="stringliteral">&quot;&#39;&quot;</span> . pg_escape_string($value) . <span class="stringliteral">&quot;&#39;::&quot;</span> . $type;
<a name="l00551"></a>00551  }
<a name="l00552"></a>00552  
<a name="l00573"></a><a class="code" href="class_c_m_postgre_s_q_l.html#a0f4b4455d44a47a695e4c6cf96488242">00573</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#a0f4b4455d44a47a695e4c6cf96488242" title="INSERT statement">insert</a>($name, $kv = <span class="keyword">false</span>, $a = <span class="keyword">false</span>) {
<a name="l00574"></a>00574   <span class="comment">// PostgreSQL is very specific about its types so we cast every value</span>
<a name="l00575"></a>00575   $desc = $this-&gt;<a class="code" href="class_c_m_postgre_s_q_l.html#a15d73ad66217294a3d22361d57058e9e" title="Describe a table.">describeTable</a>($name);
<a name="l00576"></a>00576   
<a name="l00577"></a>00577   $sql = <span class="stringliteral">&quot;insert into &quot;</span> . $this-&gt;<a class="code" href="class_c_m_postgre_s_q_l.html#a2c521548fb2e9d535673e11208bd5f6c" title="Escape an entity based on the correct rules of the database engine.">escapeEntity</a>($name) . <span class="stringliteral">&quot; (&quot;</span> . implode(<span class="charliteral">&#39;,&#39;</span>, array_keys($kv));
<a name="l00578"></a>00578   $sql .= <span class="stringliteral">&quot;) values (&quot;</span>;
<a name="l00579"></a>00579   $first = <span class="keyword">true</span>;
<a name="l00580"></a>00580   <span class="keywordflow">foreach</span>($kv as $k =&gt; $v) {
<a name="l00581"></a>00581    <span class="keywordflow">if</span>(!$first)
<a name="l00582"></a>00582     $sql .= <span class="stringliteral">&quot;,&quot;</span>;
<a name="l00583"></a>00583    
<a name="l00584"></a>00584    <span class="comment">// if its a CMConstant we don&#39;t encapsulate it</span>
<a name="l00585"></a>00585    <span class="keywordflow">if</span>($v instanceof <a class="code" href="class_c_m_constant.html" title="A container for value that need not be modified or encapsulated.">CMConstant</a> || $v instanceof <a class="code" href="class_c_m_decimal.html" title="Handling exact values.">CMDecimal</a>)
<a name="l00586"></a>00586     $sql .= $v;
<a name="l00587"></a>00587    <span class="keywordflow">else</span>
<a name="l00588"></a>00588     $sql .= $this-&gt;<a class="code" href="class_c_m_postgre_s_q_l.html#a43b7a70e62a25caeb0b9d55c32423c16" title="Cast PostgreSQL safe type.">castSafeValue</a>($v, $desc[$k]);
<a name="l00589"></a>00589     
<a name="l00590"></a>00590    $first = <span class="keyword">false</span>;
<a name="l00591"></a>00591   }
<a name="l00592"></a>00592   
<a name="l00593"></a>00593   <span class="keywordflow">if</span>($this-&gt;<a class="code" href="class_c_m_postgre_s_q_l.html#a4ced4e9cc5497c475c2cd1a03318f45a" title="Perform a query on the database that returns a handle to iterate the results.">query</a>(<span class="stringliteral">&quot;$sql)&quot;</span>, <span class="keyword">false</span>, $a)-&gt;success())
<a name="l00594"></a>00594    <span class="keywordflow">return</span> $this-&gt;<a class="code" href="class_c_m_postgre_s_q_l.html#a4ced4e9cc5497c475c2cd1a03318f45a" title="Perform a query on the database that returns a handle to iterate the results.">query</a>(<span class="stringliteral">&quot;select lastval()&quot;</span>, <span class="keyword">false</span>, $a)-&gt;fetch(<span class="stringliteral">&#39;cell&#39;</span>);
<a name="l00595"></a>00595   <span class="keywordflow">return</span> 0;
<a name="l00596"></a>00596  }
<a name="l00597"></a>00597  
<a name="l00603"></a><a class="code" href="class_c_m_postgre_s_q_l.html#a15d73ad66217294a3d22361d57058e9e">00603</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#a15d73ad66217294a3d22361d57058e9e" title="Describe a table.">describeTable</a>($table, $a = array()) {
<a name="l00604"></a>00604   $byid = $this-&gt;<a class="code" href="class_c_m_postgre_s_q_l.html#a4ced4e9cc5497c475c2cd1a03318f45a" title="Perform a query on the database that returns a handle to iterate the results.">query</a>(<span class="stringliteral">&quot;select * from information_schema.columns where table_name=? order by ordinal_position&quot;</span>, $table)-&gt;fetchAll();
<a name="l00605"></a>00605   $byname = array();
<a name="l00606"></a>00606   <span class="keywordflow">foreach</span>($byid as $v)
<a name="l00607"></a>00607    $byname[$v[<span class="stringliteral">&#39;column_name&#39;</span>]] = $v;
<a name="l00608"></a>00608   <span class="keywordflow">return</span> array_merge($byid, $byname);
<a name="l00609"></a>00609  }
<a name="l00610"></a>00610  
<a name="l00616"></a><a class="code" href="class_c_m_postgre_s_q_l.html#a36b890fb5812fc1247b8afe7d56e72ea">00616</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#a36b890fb5812fc1247b8afe7d56e72ea" title="Fetch the list of tables in the active database.">getTableNames</a>($schema = <span class="keyword">false</span>) {
<a name="l00617"></a>00617   $filter = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00618"></a>00618   <span class="keywordflow">if</span>($schema !== <span class="keyword">false</span>)
<a name="l00619"></a>00619    $filter = <span class="stringliteral">&quot;where table_schema=&#39;$schema&#39;&quot;</span>;
<a name="l00620"></a>00620   <span class="keywordflow">return</span> $this-&gt;<a class="code" href="class_c_m_postgre_s_q_l.html#a4ced4e9cc5497c475c2cd1a03318f45a" title="Perform a query on the database that returns a handle to iterate the results.">query</a>(<span class="stringliteral">&quot;select table_schema || &#39;.&#39; || table_name from information_schema.tables $filter order by table_schema, table_name&quot;</span>)-&gt;fetchAll(<span class="stringliteral">&#39;line&#39;</span>, <span class="stringliteral">&#39;vertical&#39;</span>);
<a name="l00621"></a>00621  }
<a name="l00622"></a>00622  
<a name="l00628"></a><a class="code" href="class_c_m_postgre_s_q_l.html#ae7cdaa744d52a1eb0103e377023ca528">00628</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#ae7cdaa744d52a1eb0103e377023ca528" title="Check if a table exists.">tableExists</a>($table) {
<a name="l00629"></a>00629   <span class="keywordflow">return</span> $this-&gt;<a class="code" href="class_c_m_postgre_s_q_l.html#a4ced4e9cc5497c475c2cd1a03318f45a" title="Perform a query on the database that returns a handle to iterate the results.">query</a>(<span class="stringliteral">&quot;select count(1) from information_schema.tables where table_name=?&quot;</span>, $table)-&gt;fetch(<span class="stringliteral">&#39;cell&#39;</span>);
<a name="l00630"></a>00630  }
<a name="l00631"></a>00631 
<a name="l00637"></a><a class="code" href="class_c_m_postgre_s_q_l.html#a7cf4f2839a152f2c11f5893c640c19dd">00637</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#a7cf4f2839a152f2c11f5893c640c19dd" title="Get schema names.">getSchemaNames</a>() {
<a name="l00638"></a>00638   <span class="keywordflow">return</span> $this-&gt;<a class="code" href="class_c_m_postgre_s_q_l.html#a4ced4e9cc5497c475c2cd1a03318f45a" title="Perform a query on the database that returns a handle to iterate the results.">query</a>(<span class="stringliteral">&quot;select distinct table_schema from information_schema.tables order by table_schema&quot;</span>)-&gt;fetchAll(<span class="stringliteral">&#39;line&#39;</span>, <span class="stringliteral">&#39;vertical&#39;</span>);
<a name="l00639"></a>00639  }
<a name="l00640"></a>00640  
<a name="l00651"></a><a class="code" href="class_c_m_postgre_s_q_l.html#aa45cf2b82a91150a11cd11fa0bf2847c">00651</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#aa45cf2b82a91150a11cd11fa0bf2847c" title="Class methods available implemented class.">availableMethods</a>() {
<a name="l00652"></a>00652   <span class="keywordflow">return</span> array(<span class="stringliteral">&#39;commit&#39;</span>, <span class="stringliteral">&#39;delete&#39;</span>, <span class="stringliteral">&#39;disconnect&#39;</span>, <span class="stringliteral">&#39;engine&#39;</span>, <span class="stringliteral">&#39;eraseTable&#39;</span>, <span class="stringliteral">&#39;escapeString&#39;</span>, <span class="stringliteral">&#39;execute&#39;</span>,
<a name="l00653"></a>00653                <span class="stringliteral">&#39;getClientEncoding&#39;</span>, <span class="stringliteral">&#39;getClientVersion&#39;</span>, <span class="stringliteral">&#39;getDatabaseName&#39;</span>, <span class="stringliteral">&#39;getDatabaseNames&#39;</span>,
<a name="l00654"></a>00654                <span class="stringliteral">&#39;getHost&#39;</span>, <span class="stringliteral">&#39;getPort&#39;</span>, <span class="stringliteral">&#39;getProtocolVersion&#39;</span>, <span class="stringliteral">&#39;getSchemaNames&#39;</span>, <span class="stringliteral">&#39;getServerVersion&#39;</span>,
<a name="l00655"></a>00655                <span class="stringliteral">&#39;getTableNames&#39;</span>, <span class="stringliteral">&#39;getTTY&#39;</span>, <span class="stringliteral">&#39;insert&#39;</span>, <span class="stringliteral">&#39;isConnected&#39;</span>, <span class="stringliteral">&#39;ping&#39;</span>, <span class="stringliteral">&#39;query&#39;</span>, <span class="stringliteral">&#39;reconnect&#39;</span>,
<a name="l00656"></a>00656                <span class="stringliteral">&#39;rollback&#39;</span>, <span class="stringliteral">&#39;setAutoCommit&#39;</span>, <span class="stringliteral">&#39;setClientEncoding&#39;</span>, <span class="stringliteral">&#39;tableExists&#39;</span>, <span class="stringliteral">&#39;truncateTable&#39;</span>,
<a name="l00657"></a>00657                <span class="stringliteral">&#39;update&#39;</span>, <span class="stringliteral">&#39;loadSQLFile&#39;</span>, <span class="stringliteral">&#39;dropTable&#39;</span>, <span class="stringliteral">&#39;dropAllTables&#39;</span>);
<a name="l00658"></a>00658  }
<a name="l00659"></a>00659  
<a name="l00663"></a><a class="code" href="class_c_m_postgre_s_q_l.html#af160f7fbbf281d018ae3162521b8267d">00663</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#af160f7fbbf281d018ae3162521b8267d" title="Check if the database is connected.">isConnected</a>() {
<a name="l00664"></a>00664   <span class="keywordflow">return</span> pg_connection_status($this-&gt;dbh) === PGSQL_CONNECTION_OK;
<a name="l00665"></a>00665  }
<a name="l00666"></a>00666  
<a name="l00672"></a><a class="code" href="class_c_m_postgre_s_q_l.html#abe175fcf658475bc56e9d6fa02bc88ec">00672</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#abe175fcf658475bc56e9d6fa02bc88ec" title="Disconnect database handle.">disconnect</a>() {
<a name="l00673"></a>00673   pg_close($this-&gt;dbh);
<a name="l00674"></a>00674   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00675"></a>00675  }
<a name="l00676"></a>00676  
<a name="l00682"></a><a class="code" href="class_c_m_postgre_s_q_l.html#a8147e0a0a8e607106004e2571195e01c">00682</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#a8147e0a0a8e607106004e2571195e01c" title="Get database product name.">engine</a>() {
<a name="l00683"></a>00683   <span class="keywordflow">return</span> <span class="stringliteral">&quot;PostgreSQL&quot;</span>;
<a name="l00684"></a>00684  }
<a name="l00685"></a>00685  
<a name="l00695"></a><a class="code" href="class_c_m_postgre_s_q_l.html#af5674c27d4a92f6228565010eacbb9cb">00695</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#af5674c27d4a92f6228565010eacbb9cb" title="COMMIT transaction.">commit</a>() {
<a name="l00696"></a>00696   $success = pg_exec($this-&gt;dbh, <span class="stringliteral">&quot;COMMIT&quot;</span>);
<a name="l00697"></a>00697   <span class="keywordflow">if</span>(!$success)
<a name="l00698"></a>00698    $this-&gt;<a class="code" href="class_c_m_error.html#a6d110c63a1c5103df7979612ed5209d3" title="Throw a Warning level message.">throwWarning</a>(<span class="stringliteral">&quot;Failed to commit transaction&quot;</span>);
<a name="l00699"></a>00699   
<a name="l00700"></a>00700   <span class="comment">// due to the way transactions are done, we manually check if auto commit is off and start a</span>
<a name="l00701"></a>00701   <span class="comment">// new transaction</span>
<a name="l00702"></a>00702   <span class="keywordflow">if</span>(!$this-&gt;autoCommit)
<a name="l00703"></a>00703    <span class="keywordflow">if</span>(!pg_exec($this-&gt;dbh, <span class="stringliteral">&quot;BEGIN WORK&quot;</span>))
<a name="l00704"></a>00704     $this-&gt;<a class="code" href="class_c_m_error.html#a6d110c63a1c5103df7979612ed5209d3" title="Throw a Warning level message.">throwWarning</a>(<span class="stringliteral">&quot;Can not begin transaction&quot;</span>);
<a name="l00705"></a>00705    
<a name="l00706"></a>00706   <span class="keywordflow">return</span> $success;
<a name="l00707"></a>00707  }
<a name="l00708"></a>00708 
<a name="l00716"></a><a class="code" href="class_c_m_postgre_s_q_l.html#aea9c1153e0e0fc135f8d513263bf9201">00716</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#aea9c1153e0e0fc135f8d513263bf9201" title="Get an array of database names.">getDatabaseNames</a>() {
<a name="l00717"></a>00717   <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00718"></a>00718  }
<a name="l00719"></a>00719 
<a name="l00729"></a><a class="code" href="class_c_m_postgre_s_q_l.html#afa549adf79e3f8c09fe8f903dd5fbfa7">00729</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#afa549adf79e3f8c09fe8f903dd5fbfa7" title="ROLLBACK transaction.">rollback</a>() {
<a name="l00730"></a>00730   $success = pg_exec($this-&gt;dbh, <span class="stringliteral">&quot;ROLLBACK&quot;</span>);
<a name="l00731"></a>00731   <span class="keywordflow">if</span>(!$success)
<a name="l00732"></a>00732    $this-&gt;<a class="code" href="class_c_m_error.html#a6d110c63a1c5103df7979612ed5209d3" title="Throw a Warning level message.">throwWarning</a>(<span class="stringliteral">&quot;Failed to rollback transaction&quot;</span>);
<a name="l00733"></a>00733   
<a name="l00734"></a>00734   <span class="comment">// due to the way transactions are done, we manually check if auto commit is off and start a</span>
<a name="l00735"></a>00735   <span class="comment">// new transaction</span>
<a name="l00736"></a>00736   <span class="keywordflow">if</span>(!$this-&gt;autoCommit)
<a name="l00737"></a>00737    <span class="keywordflow">if</span>(!pg_exec($this-&gt;dbh, <span class="stringliteral">&quot;BEGIN WORK&quot;</span>))
<a name="l00738"></a>00738     $this-&gt;<a class="code" href="class_c_m_error.html#a6d110c63a1c5103df7979612ed5209d3" title="Throw a Warning level message.">throwWarning</a>(<span class="stringliteral">&quot;Can not begin transaction&quot;</span>);
<a name="l00739"></a>00739    
<a name="l00740"></a>00740   <span class="keywordflow">return</span> $success;
<a name="l00741"></a>00741  }
<a name="l00742"></a>00742 
<a name="l00760"></a><a class="code" href="class_c_m_postgre_s_q_l.html#af569120fcd4d04f33780d9c10daf144c">00760</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#af569120fcd4d04f33780d9c10daf144c" title="Turn autocommit on/off.">setAutoCommit</a>($mode = <span class="keyword">false</span>) {
<a name="l00761"></a>00761   $this-&gt;autoCommit = $mode;
<a name="l00762"></a>00762   <span class="keywordflow">if</span>(!$this-&gt;autoCommit)
<a name="l00763"></a>00763    <span class="keywordflow">if</span>(!pg_exec($this-&gt;dbh, <span class="stringliteral">&quot;BEGIN WORK&quot;</span>))
<a name="l00764"></a>00764     $this-&gt;<a class="code" href="class_c_m_error.html#a6d110c63a1c5103df7979612ed5209d3" title="Throw a Warning level message.">throwWarning</a>(<span class="stringliteral">&quot;Can not begin transaction&quot;</span>);
<a name="l00765"></a>00765   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00766"></a>00766  }
<a name="l00767"></a>00767  
<a name="l00771"></a><a class="code" href="class_c_m_postgre_s_q_l.html#a7516ca30af0db3cdbf9a7739b48ce91d">00771</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#a7516ca30af0db3cdbf9a7739b48ce91d" title="Return the string value of this object.">__toString</a>() {
<a name="l00772"></a>00772   <span class="keywordflow">return</span> <span class="stringliteral">&quot;&lt;&quot;</span> . get_class($this) . <span class="stringliteral">&quot;&gt;&quot;</span>;
<a name="l00773"></a>00773  }
<a name="l00774"></a>00774  
<a name="l00791"></a><a class="code" href="class_c_m_postgre_s_q_l.html#a7e4edd82127e0c6a2f42158fdbb258d3">00791</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#a7e4edd82127e0c6a2f42158fdbb258d3" title="Erase (not truncate) a table.">eraseTable</a>($tableName) {
<a name="l00792"></a>00792   <span class="comment">// need a valid database handle</span>
<a name="l00793"></a>00793   <span class="keywordflow">if</span>($this-&gt;dbh === <span class="keyword">false</span>)
<a name="l00794"></a>00794    <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00795"></a>00795   
<a name="l00796"></a>00796   $q = $this-&gt;<a class="code" href="class_c_m_postgre_s_q_l.html#a4ced4e9cc5497c475c2cd1a03318f45a" title="Perform a query on the database that returns a handle to iterate the results.">query</a>(<span class="stringliteral">&quot;DELETE FROM &quot;</span> . $this-&gt;<a class="code" href="class_c_m_postgre_s_q_l.html#a2c521548fb2e9d535673e11208bd5f6c" title="Escape an entity based on the correct rules of the database engine.">escapeEntity</a>($tableName) . <span class="stringliteral">&quot; WHERE 1&quot;</span>);
<a name="l00797"></a>00797   <span class="keywordflow">return</span> $q-&gt;success();
<a name="l00798"></a>00798  }
<a name="l00799"></a>00799  
<a name="l00815"></a><a class="code" href="class_c_m_postgre_s_q_l.html#aff013143f73f33653e2f60fecbde00cb">00815</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#aff013143f73f33653e2f60fecbde00cb" title="TRUNCATE table.">truncateTable</a>($tableName) {
<a name="l00816"></a>00816   <span class="comment">// need a valid database handle</span>
<a name="l00817"></a>00817   <span class="keywordflow">if</span>($this-&gt;dbh === <span class="keyword">false</span>)
<a name="l00818"></a>00818    <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00819"></a>00819   
<a name="l00820"></a>00820   $q = $this-&gt;<a class="code" href="class_c_m_postgre_s_q_l.html#a4ced4e9cc5497c475c2cd1a03318f45a" title="Perform a query on the database that returns a handle to iterate the results.">query</a>(<span class="stringliteral">&quot;TRUNCATE TABLE &quot;</span> . $this-&gt;<a class="code" href="class_c_m_postgre_s_q_l.html#a2c521548fb2e9d535673e11208bd5f6c" title="Escape an entity based on the correct rules of the database engine.">escapeEntity</a>($tableName));
<a name="l00821"></a>00821   <span class="keywordflow">return</span> $q-&gt;success();
<a name="l00822"></a>00822  }
<a name="l00823"></a>00823  
<a name="l00836"></a><a class="code" href="class_c_m_postgre_s_q_l.html#ac32a7f2a2c349c061f600bc0ac2fec86">00836</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#ac32a7f2a2c349c061f600bc0ac2fec86" title="UPDATE statement.">update</a>($tableName, $newvalues, $criteria = <span class="keyword">false</span>, $a = <span class="keyword">false</span>) {
<a name="l00837"></a>00837   <span class="comment">// PostgreSQL is very specific about its types so we cast every value</span>
<a name="l00838"></a>00838   $desc = $this-&gt;<a class="code" href="class_c_m_postgre_s_q_l.html#a15d73ad66217294a3d22361d57058e9e" title="Describe a table.">describeTable</a>($tableName);
<a name="l00839"></a>00839   
<a name="l00840"></a>00840   <span class="comment">// $a must be an array</span>
<a name="l00841"></a>00841   <span class="keywordflow">if</span>(!is_array($a))
<a name="l00842"></a>00842    $a = array();
<a name="l00843"></a>00843   
<a name="l00844"></a>00844   $sql = <span class="stringliteral">&quot;UPDATE &quot;</span> . $this-&gt;<a class="code" href="class_c_m_postgre_s_q_l.html#a2c521548fb2e9d535673e11208bd5f6c" title="Escape an entity based on the correct rules of the database engine.">escapeEntity</a>($tableName) . <span class="stringliteral">&quot; SET &quot;</span>;
<a name="l00845"></a>00845   $first = <span class="keyword">true</span>;
<a name="l00846"></a>00846   <span class="keywordflow">foreach</span>($newvalues as $k =&gt; $v) {
<a name="l00847"></a>00847    <span class="keywordflow">if</span>(!$first)
<a name="l00848"></a>00848     $sql .= <span class="stringliteral">&quot;,&quot;</span>;
<a name="l00849"></a>00849    
<a name="l00850"></a>00850    <span class="comment">// if its a CMConstant we don&#39;t encapsulate it</span>
<a name="l00851"></a>00851    <span class="keywordflow">if</span>($v instanceof <a class="code" href="class_c_m_constant.html" title="A container for value that need not be modified or encapsulated.">CMConstant</a> || $v instanceof <a class="code" href="class_c_m_decimal.html" title="Handling exact values.">CMDecimal</a>)
<a name="l00852"></a>00852     $sql .= <span class="stringliteral">&quot;$k=$v&quot;</span>;
<a name="l00853"></a>00853    <span class="keywordflow">else</span>
<a name="l00854"></a>00854     $sql .= <span class="stringliteral">&quot;$k=&quot;</span> . $this-&gt;<a class="code" href="class_c_m_postgre_s_q_l.html#a43b7a70e62a25caeb0b9d55c32423c16" title="Cast PostgreSQL safe type.">castSafeValue</a>($v, $desc[$k]);
<a name="l00855"></a>00855    
<a name="l00856"></a>00856    $first = <span class="keyword">false</span>;
<a name="l00857"></a>00857   }
<a name="l00858"></a>00858   
<a name="l00859"></a>00859   <span class="comment">// add WHERE clause</span>
<a name="l00860"></a>00860   <span class="keywordflow">if</span>($criteria !== <span class="keyword">false</span>) {
<a name="l00861"></a>00861    $sql .= <span class="stringliteral">&quot; WHERE &quot;</span>;
<a name="l00862"></a>00862    $first = <span class="keyword">true</span>;
<a name="l00863"></a>00863    <span class="keywordflow">foreach</span>($criteria as $k =&gt; $v) {
<a name="l00864"></a>00864     <span class="keywordflow">if</span>(!$first)
<a name="l00865"></a>00865      $sql .= <span class="stringliteral">&quot; AND &quot;</span>;
<a name="l00866"></a>00866     
<a name="l00867"></a>00867     <span class="comment">// if its a CMConstant we don&#39;t encapsulate it</span>
<a name="l00868"></a>00868     <span class="keywordflow">if</span>($v instanceof <a class="code" href="class_c_m_constant.html" title="A container for value that need not be modified or encapsulated.">CMConstant</a> || $v instanceof <a class="code" href="class_c_m_decimal.html" title="Handling exact values.">CMDecimal</a>)
<a name="l00869"></a>00869      $sql .= <span class="stringliteral">&quot;$k=$v&quot;</span>;
<a name="l00870"></a>00870     <span class="keywordflow">else</span>
<a name="l00871"></a>00871      $sql .= <span class="stringliteral">&quot;$k=&#39;&quot;</span> . pg_escape_string($v) . <span class="stringliteral">&quot;&#39;&quot;</span>;
<a name="l00872"></a>00872     
<a name="l00873"></a>00873     $first = <span class="keyword">false</span>;
<a name="l00874"></a>00874    }
<a name="l00875"></a>00875   }
<a name="l00876"></a>00876   
<a name="l00877"></a>00877   <span class="keywordflow">if</span>(isset($a[<span class="stringliteral">&#39;print&#39;</span>]))
<a name="l00878"></a>00878    echo $sql;
<a name="l00879"></a>00879   
<a name="l00880"></a>00880   $q = $this-&gt;<a class="code" href="class_c_m_postgre_s_q_l.html#a4ced4e9cc5497c475c2cd1a03318f45a" title="Perform a query on the database that returns a handle to iterate the results.">query</a>($sql, <span class="keyword">false</span>, $a);
<a name="l00881"></a>00881   <span class="keywordflow">if</span>($q-&gt;success())
<a name="l00882"></a>00882    <span class="keywordflow">return</span> $q-&gt;affectedRows();
<a name="l00883"></a>00883   <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00884"></a>00884  }
<a name="l00885"></a>00885  
<a name="l00897"></a><a class="code" href="class_c_m_postgre_s_q_l.html#a2415ba06f043f104ed33b9571f200fc8">00897</a>  <span class="keyword">public</span> function <span class="keyword">delete</span>($tableName, $criteria = <span class="keyword">false</span>, $a = <span class="keyword">false</span>) {
<a name="l00898"></a>00898   <span class="comment">// $a must be an array</span>
<a name="l00899"></a>00899   <span class="keywordflow">if</span>(!is_array($a))
<a name="l00900"></a>00900    $a = array();
<a name="l00901"></a>00901   
<a name="l00902"></a>00902   $sql = <span class="stringliteral">&quot;DELETE FROM &quot;</span> . $this-&gt;<a class="code" href="class_c_m_postgre_s_q_l.html#a2c521548fb2e9d535673e11208bd5f6c" title="Escape an entity based on the correct rules of the database engine.">escapeEntity</a>($tableName);
<a name="l00903"></a>00903   
<a name="l00904"></a>00904   <span class="comment">// add WHERE clause</span>
<a name="l00905"></a>00905   <span class="keywordflow">if</span>($criteria !== <span class="keyword">false</span>) {
<a name="l00906"></a>00906    $sql .= <span class="stringliteral">&quot; WHERE &quot;</span>;
<a name="l00907"></a>00907    $first = <span class="keyword">true</span>;
<a name="l00908"></a>00908    <span class="keywordflow">foreach</span>($criteria as $k =&gt; $v) {
<a name="l00909"></a>00909     <span class="keywordflow">if</span>(!$first) $sql .= <span class="stringliteral">&quot; AND &quot;</span>;
<a name="l00910"></a>00910     
<a name="l00911"></a>00911     <span class="comment">// if its a CMConstant we don&#39;t encapsulate it</span>
<a name="l00912"></a>00912     <span class="keywordflow">if</span>($v instanceof <a class="code" href="class_c_m_constant.html" title="A container for value that need not be modified or encapsulated.">CMConstant</a> || $v instanceof <a class="code" href="class_c_m_decimal.html" title="Handling exact values.">CMDecimal</a>)
<a name="l00913"></a>00913      $sql .= <span class="stringliteral">&quot;$k=$v&quot;</span>;
<a name="l00914"></a>00914     <span class="keywordflow">else</span>
<a name="l00915"></a>00915      $sql .= <span class="stringliteral">&quot;$k=&#39;&quot;</span> . pg_escape_string($v) . <span class="stringliteral">&quot;&#39;&quot;</span>;
<a name="l00916"></a>00916     
<a name="l00917"></a>00917     $first = <span class="keyword">false</span>;
<a name="l00918"></a>00918    }
<a name="l00919"></a>00919   }
<a name="l00920"></a>00920   
<a name="l00921"></a>00921   <span class="keywordflow">if</span>(isset($a[<span class="stringliteral">&#39;print&#39;</span>]))
<a name="l00922"></a>00922    echo $sql;
<a name="l00923"></a>00923   
<a name="l00924"></a>00924   $q = $this-&gt;<a class="code" href="class_c_m_postgre_s_q_l.html#a4ced4e9cc5497c475c2cd1a03318f45a" title="Perform a query on the database that returns a handle to iterate the results.">query</a>($sql, <span class="keyword">false</span>, $a);
<a name="l00925"></a>00925   <span class="keywordflow">if</span>($q-&gt;success())
<a name="l00926"></a>00926    <span class="keywordflow">return</span> $q-&gt;affectedRows();
<a name="l00927"></a>00927   <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00928"></a>00928  }
<a name="l00929"></a>00929  
<a name="l00939"></a><a class="code" href="class_c_m_postgre_s_q_l.html#ad46d13881d4b1b0351d97290062ddb56">00939</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#ad46d13881d4b1b0351d97290062ddb56" title="Gets the client encoding.">getClientEncoding</a>() {
<a name="l00940"></a>00940   <span class="keywordflow">return</span> pg_client_encoding($this-&gt;dbh);
<a name="l00941"></a>00941  }
<a name="l00942"></a>00942  
<a name="l00950"></a><a class="code" href="class_c_m_postgre_s_q_l.html#a57c19c642ab3023e28d10c50f86ff0a8">00950</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#a57c19c642ab3023e28d10c50f86ff0a8" title="Reconnect (reset) the connection.">reconnect</a>() {
<a name="l00951"></a>00951   <span class="keywordflow">return</span> pg_connection_reset($this-&gt;dbh);
<a name="l00952"></a>00952  }
<a name="l00953"></a>00953  
<a name="l00961"></a><a class="code" href="class_c_m_postgre_s_q_l.html#a6c2092833f367c0aefa1eee1065a2e9e">00961</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#a6c2092833f367c0aefa1eee1065a2e9e" title="Get the database name.">getDatabaseName</a>() {
<a name="l00962"></a>00962   <span class="keywordflow">return</span> pg_dbname($this-&gt;dbh);
<a name="l00963"></a>00963  }
<a name="l00964"></a>00964  
<a name="l00970"></a><a class="code" href="class_c_m_postgre_s_q_l.html#a39895a44b52bdced039e698588aaf18e">00970</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#a39895a44b52bdced039e698588aaf18e" title="Returns the host name associated with this connection.">getHost</a>() {
<a name="l00971"></a>00971   <span class="keywordflow">return</span> pg_host($this-&gt;dbh);
<a name="l00972"></a>00972  }
<a name="l00973"></a>00973  
<a name="l00979"></a><a class="code" href="class_c_m_postgre_s_q_l.html#a6dad377f74b0ce6f21b485ba11052746">00979</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#a6dad377f74b0ce6f21b485ba11052746" title="Pings a database connection and tries to reconnect it if it is broken.">ping</a>() {
<a name="l00980"></a>00980   <span class="keywordflow">return</span> pg_ping($this-&gt;dbh);
<a name="l00981"></a>00981  }
<a name="l00982"></a>00982  
<a name="l00989"></a><a class="code" href="class_c_m_postgre_s_q_l.html#afd4db46d3c12f47f0bee19cd2101be64">00989</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#afd4db46d3c12f47f0bee19cd2101be64" title="Return the port number associated with this connection.">getPort</a>() {
<a name="l00990"></a>00990   <span class="keywordflow">return</span> pg_port($this-&gt;dbh);
<a name="l00991"></a>00991  }
<a name="l00992"></a>00992  
<a name="l01006"></a><a class="code" href="class_c_m_postgre_s_q_l.html#ac221b90197ad91ac98986b15141eb499">01006</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#ac221b90197ad91ac98986b15141eb499" title="Set the client encoding.">setClientEncoding</a>($encoding) {
<a name="l01007"></a>01007   <span class="keywordflow">return</span> pg_set_client_encoding($this-&gt;dbh, $encoding);
<a name="l01008"></a>01008  }
<a name="l01009"></a>01009  
<a name="l01020"></a><a class="code" href="class_c_m_postgre_s_q_l.html#a415e7833ef2683300fd7bc775c46d6cb">01020</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#a415e7833ef2683300fd7bc775c46d6cb" title="Return the TTY name associated with the connection.">getTTY</a>() {
<a name="l01021"></a>01021   <span class="keywordflow">return</span> pg_tty($this-&gt;dbh);
<a name="l01022"></a>01022  }
<a name="l01023"></a>01023  
<a name="l01027"></a><a class="code" href="class_c_m_postgre_s_q_l.html#acc8b801086cef69cbf92b77ee7434be0">01027</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#acc8b801086cef69cbf92b77ee7434be0" title="Get the client version.">getClientVersion</a>() {
<a name="l01028"></a>01028   $v = pg_version();
<a name="l01029"></a>01029   <span class="keywordflow">return</span> $v[<span class="stringliteral">&#39;client&#39;</span>];
<a name="l01030"></a>01030  }
<a name="l01031"></a>01031  
<a name="l01035"></a><a class="code" href="class_c_m_postgre_s_q_l.html#a915c3328b367338a7c0eddb1e3294e9a">01035</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#a915c3328b367338a7c0eddb1e3294e9a" title="Get the protocol version.">getProtocolVersion</a>() {
<a name="l01036"></a>01036   $v = pg_version();
<a name="l01037"></a>01037   <span class="keywordflow">return</span> $v[<span class="stringliteral">&#39;protocol&#39;</span>];
<a name="l01038"></a>01038  }
<a name="l01039"></a>01039  
<a name="l01043"></a><a class="code" href="class_c_m_postgre_s_q_l.html#a2d047b148eb053baba2150cc7d5d9545">01043</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#a2d047b148eb053baba2150cc7d5d9545" title="Get the server version.">getServerVersion</a>() {
<a name="l01044"></a>01044   $v = pg_version();
<a name="l01045"></a>01045   <span class="keywordflow">return</span> $v[<span class="stringliteral">&#39;server_version&#39;</span>];
<a name="l01046"></a>01046  }
<a name="l01047"></a>01047  
<a name="l01054"></a><a class="code" href="class_c_m_postgre_s_q_l.html#a2d931763c47d46ab7c26ba4e69d969d7">01054</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#a2d931763c47d46ab7c26ba4e69d969d7" title="Escape a string based on the correct rules of the database engine.">escapeString</a>($str) {
<a name="l01055"></a>01055   <span class="keywordflow">return</span> pg_escape_string($str); 
<a name="l01056"></a>01056  }
<a name="l01057"></a>01057  
<a name="l01064"></a><a class="code" href="class_c_m_postgre_s_q_l.html#a7327ec53765f61a4a9d715133d2ea2db">01064</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#a7327ec53765f61a4a9d715133d2ea2db" title="Return the auto commit status.">getAutoCommit</a>() {
<a name="l01065"></a>01065   <span class="keywordflow">return</span> $this-&gt;autoCommit;
<a name="l01066"></a>01066  }
<a name="l01067"></a>01067  
<a name="l01083"></a><a class="code" href="class_c_m_postgre_s_q_l.html#ad3c2efe6828834aadd7cbe990e502645">01083</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#ad3c2efe6828834aadd7cbe990e502645" title="Load a SQL file into the current connection.">loadSQLFile</a>($path, $a = array()) {
<a name="l01084"></a>01084   <span class="comment">// prepare</span>
<a name="l01085"></a>01085   $f = fopen($path, <span class="stringliteral">&quot;r&quot;</span>);
<a name="l01086"></a>01086   <span class="keywordflow">if</span>(!$f)
<a name="l01087"></a>01087    <span class="keywordflow">return</span> $this-&gt;<a class="code" href="class_c_m_error.html#a94a6cd26c794c35133502471eca8469e" title="Throw a Error level message.">throwError</a>(<span class="stringliteral">&quot;Could not open input file $path&quot;</span>);
<a name="l01088"></a>01088   
<a name="l01089"></a>01089   <span class="comment">// read each SQL command</span>
<a name="l01090"></a>01090   $success = <span class="keyword">true</span>;
<a name="l01091"></a>01091   $sql = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01092"></a>01092   <span class="keywordflow">while</span>(<span class="keyword">true</span>) {
<a name="l01093"></a>01093    $c = fgetc($f);
<a name="l01094"></a>01094    
<a name="l01095"></a>01095    <span class="comment">// skip whitespace</span>
<a name="l01096"></a>01096    <span class="keywordflow">while</span>(<span class="keyword">true</span>) {
<a name="l01097"></a>01097     $c = fgetc($f);
<a name="l01098"></a>01098     <span class="keywordflow">if</span>(!ctype_space($c)) {
<a name="l01099"></a>01099      fseek($f, -1, SEEK_CUR);
<a name="l01100"></a>01100      <span class="keywordflow">break</span>;
<a name="l01101"></a>01101     }
<a name="l01102"></a>01102    }
<a name="l01103"></a>01103    
<a name="l01104"></a>01104    <span class="comment">// comment</span>
<a name="l01105"></a>01105    <span class="keywordflow">if</span>($c == <span class="charliteral">&#39;-&#39;</span>) {
<a name="l01106"></a>01106     <span class="keywordflow">if</span>(fgetc($f) == <span class="charliteral">&#39;-&#39;</span>) {
<a name="l01107"></a>01107      <span class="comment">// keep reading until the comment ends</span>
<a name="l01108"></a>01108      <span class="keywordflow">while</span>(<span class="keyword">true</span>) {
<a name="l01109"></a>01109       $c = fgetc($f);
<a name="l01110"></a>01110       <span class="keywordflow">if</span>($c == <span class="stringliteral">&quot;\n&quot;</span> || $c == <span class="stringliteral">&quot;\r&quot;</span> || feof($f))
<a name="l01111"></a>01111        <span class="keywordflow">break</span>;
<a name="l01112"></a>01112      }
<a name="l01113"></a>01113      <span class="keywordflow">continue</span>;
<a name="l01114"></a>01114     }
<a name="l01115"></a>01115     <span class="keywordflow">else</span>
<a name="l01116"></a>01116      fseek($f, -1, SEEK_CUR);
<a name="l01117"></a>01117    }
<a name="l01118"></a>01118    
<a name="l01119"></a>01119    <span class="comment">// reading SQL</span>
<a name="l01120"></a>01120    <span class="keywordflow">while</span>(<span class="keyword">true</span>) {
<a name="l01121"></a>01121     $c = fgetc($f);
<a name="l01122"></a>01122     <span class="keywordflow">if</span>($c == <span class="stringliteral">&quot;;&quot;</span> || feof($f)) {
<a name="l01123"></a>01123      $sql = trim($sql);
<a name="l01124"></a>01124      <span class="keywordflow">if</span>($sql != <span class="stringliteral">&quot;&quot;</span>)
<a name="l01125"></a>01125       $this-&gt;<a class="code" href="class_c_m_postgre_s_q_l.html#a4ced4e9cc5497c475c2cd1a03318f45a" title="Perform a query on the database that returns a handle to iterate the results.">query</a>($sql);
<a name="l01126"></a>01126       
<a name="l01127"></a>01127      <span class="comment">// reset</span>
<a name="l01128"></a>01128      $sql = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01129"></a>01129      <span class="keywordflow">break</span>;
<a name="l01130"></a>01130     }
<a name="l01131"></a>01131     $sql .= $c;
<a name="l01132"></a>01132    }
<a name="l01133"></a>01133    
<a name="l01134"></a>01134    <span class="keywordflow">if</span>(feof($f))
<a name="l01135"></a>01135     <span class="keywordflow">break</span>;
<a name="l01136"></a>01136   }
<a name="l01137"></a>01137   
<a name="l01138"></a>01138   <span class="keywordflow">return</span> $success;
<a name="l01139"></a>01139  }
<a name="l01140"></a>01140  
<a name="l01151"></a><a class="code" href="class_c_m_postgre_s_q_l.html#a636f7a668ee9a070750857297c7a9c30">01151</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#a636f7a668ee9a070750857297c7a9c30" title="Drop (delete) a table.">dropTable</a>($tablename, $a = array()) {
<a name="l01152"></a>01152   $sql = <span class="stringliteral">&quot;DROP TABLE $tablename&quot;</span>;
<a name="l01153"></a>01153   
<a name="l01154"></a>01154   <span class="keywordflow">if</span>(!isset($a[<span class="stringliteral">&#39;cascade&#39;</span>]))
<a name="l01155"></a>01155    $a[<span class="stringliteral">&#39;cascade&#39;</span>] = <span class="keyword">true</span>;
<a name="l01156"></a>01156   <span class="keywordflow">if</span>($a[<span class="stringliteral">&#39;cascade&#39;</span>])
<a name="l01157"></a>01157    $sql .= <span class="stringliteral">&quot; CASCADE&quot;</span>;
<a name="l01158"></a>01158    
<a name="l01159"></a>01159   <span class="keywordflow">return</span> $this-&gt;<a class="code" href="class_c_m_postgre_s_q_l.html#a13148537025768f2373012227785c540" title="Perform a query on the database that does not return a handle.">execute</a>($sql);
<a name="l01160"></a>01160  }
<a name="l01161"></a>01161  
<a name="l01171"></a><a class="code" href="class_c_m_postgre_s_q_l.html#ad3de705f0ea42a5576f604b7ae2e1ea6">01171</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#ad3de705f0ea42a5576f604b7ae2e1ea6" title="Drop all of the tables in the current database.">dropAllTables</a>($a = array()) {
<a name="l01172"></a>01172   $tables = $this-&gt;<a class="code" href="class_c_m_postgre_s_q_l.html#a36b890fb5812fc1247b8afe7d56e72ea" title="Fetch the list of tables in the active database.">getTableNames</a>(<span class="stringliteral">&#39;public&#39;</span>);
<a name="l01173"></a>01173   $success = <span class="keyword">true</span>;
<a name="l01174"></a>01174   
<a name="l01175"></a>01175   <span class="keywordflow">foreach</span>($tables as $table)
<a name="l01176"></a>01176    $success = $success &amp;&amp; $this-&gt;<a class="code" href="class_c_m_postgre_s_q_l.html#a636f7a668ee9a070750857297c7a9c30" title="Drop (delete) a table.">dropTable</a>($table);
<a name="l01177"></a>01177   
<a name="l01178"></a>01178   <span class="keywordflow">return</span> $success;
<a name="l01179"></a>01179  }
<a name="l01180"></a>01180  
<a name="l01190"></a><a class="code" href="class_c_m_postgre_s_q_l.html#a2c521548fb2e9d535673e11208bd5f6c">01190</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#a2c521548fb2e9d535673e11208bd5f6c" title="Escape an entity based on the correct rules of the database engine.">escapeEntity</a>($str) {
<a name="l01191"></a>01191   <span class="keywordflow">return</span> <span class="stringliteral">&quot;\&quot;$str\&quot;&quot;</span>;
<a name="l01192"></a>01192  }
<a name="l01193"></a>01193  
<a name="l01198"></a><a class="code" href="class_c_m_postgre_s_q_l.html#abf89f1eb88b512c20220370fea61ad78">01198</a>  <span class="keyword">public</span> <span class="keyword">static</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#abf89f1eb88b512c20220370fea61ad78" title="Translate a SQL ARRAY into a PHP array.">Arrayify</a>($data) {
<a name="l01199"></a>01199   <span class="keywordflow">if</span>(@substr($data, 0, 1) != <span class="charliteral">&#39;{&#39;</span>)
<a name="l01200"></a>01200    <span class="keywordflow">return</span> NULL;
<a name="l01201"></a>01201   
<a name="l01202"></a>01202   <span class="keywordflow">return</span> explode(<span class="stringliteral">&quot;,&quot;</span>, substr($data, 1, strlen($data) - 2));
<a name="l01203"></a>01203  }
<a name="l01204"></a>01204  
<a name="l01205"></a>01205 }
<a name="l01206"></a>01206 
<a name="l01207"></a>01207 ?&gt;
</pre></div></div>
<hr class="footer"/><address style="text-align: right;"><small>Generated by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
