<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>CMLIB: CMPostgreSQL.php Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    </ul>
  </div>
<h1>CMPostgreSQL.php</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00002"></a>00002 
<a name="l00003"></a>00003 include_once(<span class="stringliteral">&quot;CMDatabaseProtocol.php&quot;</span>);
<a name="l00004"></a>00004 include_once(<span class="stringliteral">&quot;CMPostgreSQLQuery.php&quot;</span>);
<a name="l00005"></a>00005 include_once(<span class="stringliteral">&quot;CMConstant.php&quot;</span>);
<a name="l00006"></a>00006 include_once(<span class="stringliteral">&quot;CMError.php&quot;</span>);
<a name="l00007"></a>00007 
<a name="l00350"></a><a class="code" href="class_c_m_postgre_s_q_l.html">00350</a> <span class="keyword">class </span><a class="code" href="class_c_m_postgre_s_q_l.html" title="PostgreSQL connectivity class.">CMPostgreSQL</a> <span class="keyword">extends</span> <a class="code" href="class_c_m_error.html" title="Error handling as a stand-alone or for classes vis inheritance.">CMError</a> implements <a class="code" href="interface_c_m_database_protocol.html" title="All database connectivity classes implement this interface.">CMDatabaseProtocol</a> {
<a name="l00351"></a>00351  
<a name="l00357"></a><a class="code" href="class_c_m_postgre_s_q_l.html#a9e2d53558e7b299d52b25c13d310d7e0">00357</a>  <span class="keyword">public</span> <span class="keyword">static</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#a9e2d53558e7b299d52b25c13d310d7e0" title="The version of this class.">Version</a>() {
<a name="l00358"></a>00358   <span class="keywordflow">return</span> <span class="stringliteral">&quot;1.0&quot;</span>;
<a name="l00359"></a>00359  }
<a name="l00360"></a>00360  
<a name="l00366"></a><a class="code" href="class_c_m_postgre_s_q_l.html#ab51e04ce58ff27601a503f46d611b7e6">00366</a>  <span class="keyword">public</span> <span class="keyword">static</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#ab51e04ce58ff27601a503f46d611b7e6" title="The version this class was introduced to the library.">Since</a>() {
<a name="l00367"></a>00367   <span class="keywordflow">return</span> <span class="stringliteral">&quot;1.0&quot;</span>;
<a name="l00368"></a>00368  }
<a name="l00369"></a>00369  
<a name="l00376"></a><a class="code" href="class_c_m_postgre_s_q_l.html#a69423cb24968e09a427084bd5f1191d3">00376</a>  <span class="keyword">private</span> <a class="code" href="class_c_m_postgre_s_q_l.html#a69423cb24968e09a427084bd5f1191d3" title="Internal auto commit flag.">$autoCommit</a> = <span class="keyword">true</span>;
<a name="l00377"></a>00377  
<a name="l00381"></a><a class="code" href="class_c_m_postgre_s_q_l.html#acc1e62674bb7200ea73767c19dc1344d">00381</a>  <span class="keyword">private</span> <a class="code" href="class_c_m_postgre_s_q_l.html#acc1e62674bb7200ea73767c19dc1344d" title="Internal database handle.">$dbh</a> = <span class="keyword">false</span>;
<a name="l00382"></a>00382  
<a name="l00397"></a><a class="code" href="class_c_m_postgre_s_q_l.html#a5bb2d2117b6f5d3646338ebf17d65d17">00397</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#a5bb2d2117b6f5d3646338ebf17d65d17" title="Connect to a PostgreSQL database.">CMPostgreSQL</a>($uri, $a = <span class="keyword">false</span>) {
<a name="l00398"></a>00398   <span class="comment">// dissect the URI</span>
<a name="l00399"></a>00399   $v = parse_url($uri);
<a name="l00400"></a>00400   $v[<span class="stringliteral">&#39;db&#39;</span>] = basename($v[<span class="stringliteral">&#39;path&#39;</span>]);
<a name="l00401"></a>00401   
<a name="l00402"></a>00402   <span class="comment">// make sure the scheme is valid</span>
<a name="l00403"></a>00403   <span class="keywordflow">if</span>($v[<span class="stringliteral">&#39;scheme&#39;</span>] != <span class="stringliteral">&#39;postgres&#39;</span> &amp;&amp; $v[<span class="stringliteral">&#39;scheme&#39;</span>] != <span class="stringliteral">&#39;postgresql&#39;</span>) {
<a name="l00404"></a>00404    $this-&gt;<a class="code" href="class_c_m_error.html#a94a6cd26c794c35133502471eca8469e" title="Throw a Error level message.">throwError</a>(<span class="stringliteral">&quot;Unsupported driver &#39;{$v[&#39;scheme&#39;]}&#39;&quot;</span>);
<a name="l00405"></a>00405    <span class="keywordflow">return</span> $this;
<a name="l00406"></a>00406   }
<a name="l00407"></a>00407   
<a name="l00408"></a>00408   <span class="comment">// attempt to connect</span>
<a name="l00409"></a>00409   $this-&gt;dbh = pg_connect(<span class="stringliteral">&quot;host={$v[&#39;host&#39;]} port=5432 dbname={$v[&#39;db&#39;]} user={$v[&#39;user&#39;]} password={$v[&#39;pass&#39;]}&quot;</span>);
<a name="l00410"></a>00410   <span class="keywordflow">if</span>(!$this-&gt;dbh) {
<a name="l00411"></a>00411    $this-&gt;<a class="code" href="class_c_m_error.html#a94a6cd26c794c35133502471eca8469e" title="Throw a Error level message.">throwError</a>(<span class="stringliteral">&quot;Could not connect to database.&quot;</span>);
<a name="l00412"></a>00412    <span class="keywordflow">return</span> $this;
<a name="l00413"></a>00413   }
<a name="l00414"></a>00414  }
<a name="l00415"></a>00415  
<a name="l00427"></a><a class="code" href="class_c_m_postgre_s_q_l.html#a4ced4e9cc5497c475c2cd1a03318f45a">00427</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#a4ced4e9cc5497c475c2cd1a03318f45a" title="Perform a query on the database that returns a handle to iterate the results.">query</a>($sql, $values = <span class="keyword">false</span>, $a = <span class="keyword">false</span>) {
<a name="l00428"></a>00428   <span class="comment">// $a must be an array</span>
<a name="l00429"></a>00429   <span class="keywordflow">if</span>(!is_array($a))
<a name="l00430"></a>00430    $a = array($a =&gt; <span class="keyword">true</span>);
<a name="l00431"></a>00431    
<a name="l00432"></a>00432   $sql = $this-&gt;<a class="code" href="class_c_m_postgre_s_q_l.html#a9510b8d39cd7053fe9cf02592f029766" title="Use internally by query() and insert() for substituting values.">bindValues</a>($sql, $values, $a);
<a name="l00433"></a>00433   
<a name="l00434"></a>00434   <span class="keywordflow">if</span>(isset($a[<span class="stringliteral">&#39;print&#39;</span>]))
<a name="l00435"></a>00435    echo <span class="stringliteral">&quot;$sql\n&quot;</span>;
<a name="l00436"></a>00436   
<a name="l00437"></a>00437   $q = @pg_query($this-&gt;dbh, $sql);
<a name="l00438"></a>00438   <span class="keywordflow">if</span>(!$q)
<a name="l00439"></a>00439    $this-&gt;<a class="code" href="class_c_m_error.html#a6d110c63a1c5103df7979612ed5209d3" title="Throw a Warning level message.">throwWarning</a>(<span class="stringliteral">&quot;Query failed&quot;</span>, array(<span class="stringliteral">&#39;sql&#39;</span> =&gt; $sql));
<a name="l00440"></a>00440   <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="class_c_m_postgre_s_q_l_query.html" title="PostgreSQL query handle.">CMPostgreSQLQuery</a>($q, $a);
<a name="l00441"></a>00441  }
<a name="l00442"></a>00442  
<a name="l00458"></a><a class="code" href="class_c_m_postgre_s_q_l.html#a9510b8d39cd7053fe9cf02592f029766">00458</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#a9510b8d39cd7053fe9cf02592f029766" title="Use internally by query() and insert() for substituting values.">bindValues</a>($sql, $values = <span class="keyword">false</span>, $a = <span class="keyword">false</span>) {
<a name="l00459"></a>00459   <span class="keywordflow">if</span>(is_array($values)) {
<a name="l00460"></a>00460    $parts = explode(<span class="charliteral">&#39;?&#39;</span>, $sql);
<a name="l00461"></a>00461    $new_sql = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00462"></a>00462    <span class="keywordflow">for</span>($i = 0; $i &lt; count($parts) - 1; ++$i) {
<a name="l00463"></a>00463     <span class="comment">// if its a CMConstant we don&#39;t encapsulate it</span>
<a name="l00464"></a>00464     <span class="keywordflow">if</span>($values[$i] instanceof <a class="code" href="class_c_m_constant.html" title="A container for value that need not be modified or encapsulated.">CMConstant</a>)
<a name="l00465"></a>00465      $new_sql .= $parts[$i] . $values[$i];
<a name="l00466"></a>00466     <span class="keywordflow">else</span> $new_sql .= $parts[$i] . <span class="stringliteral">&quot;&#39;&quot;</span> . pg_escape_string($values[$i]) . <span class="stringliteral">&quot;&#39;&quot;</span>;
<a name="l00467"></a>00467    }
<a name="l00468"></a>00468    $sql = $new_sql . $parts[count($parts) - 1];
<a name="l00469"></a>00469   } elseif($values !== <span class="keyword">false</span>) {
<a name="l00470"></a>00470    <span class="comment">// if its a CMConstant we don&#39;t encapsulate it</span>
<a name="l00471"></a>00471    <span class="keywordflow">if</span>($values instanceof <a class="code" href="class_c_m_constant.html" title="A container for value that need not be modified or encapsulated.">CMConstant</a>)
<a name="l00472"></a>00472     $sql = str_replace(<span class="charliteral">&#39;?&#39;</span>, $values, $sql);
<a name="l00473"></a>00473    <span class="keywordflow">else</span> $sql = str_replace(<span class="charliteral">&#39;?&#39;</span>, <span class="stringliteral">&quot;&#39;&quot;</span> . pg_escape_string($values) . <span class="stringliteral">&quot;&#39;&quot;</span>, $sql);
<a name="l00474"></a>00474   }
<a name="l00475"></a>00475    
<a name="l00476"></a>00476   <span class="keywordflow">return</span> $sql;
<a name="l00477"></a>00477  }
<a name="l00478"></a>00478  
<a name="l00491"></a><a class="code" href="class_c_m_postgre_s_q_l.html#a13148537025768f2373012227785c540">00491</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#a13148537025768f2373012227785c540" title="Perform a query on the database that does not return a handle.">execute</a>($sql, $values = <span class="keyword">false</span>, $a = <span class="keyword">false</span>) {
<a name="l00492"></a>00492   $q = $this-&gt;<a class="code" href="class_c_m_postgre_s_q_l.html#a4ced4e9cc5497c475c2cd1a03318f45a" title="Perform a query on the database that returns a handle to iterate the results.">query</a>($sql, $values, $a);
<a name="l00493"></a>00493   <span class="keywordflow">return</span> $q-&gt;success();
<a name="l00494"></a>00494  }
<a name="l00495"></a>00495  
<a name="l00516"></a><a class="code" href="class_c_m_postgre_s_q_l.html#a0f4b4455d44a47a695e4c6cf96488242">00516</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#a0f4b4455d44a47a695e4c6cf96488242" title="INSERT statement">insert</a>($name, $kv = <span class="keyword">false</span>, $a = <span class="keyword">false</span>) {
<a name="l00517"></a>00517   $sql = <span class="stringliteral">&quot;insert into \&quot;$name\&quot; (&quot;</span> . implode(<span class="charliteral">&#39;,&#39;</span>, array_keys($kv)) . <span class="stringliteral">&quot;) values (&quot;</span>;
<a name="l00518"></a>00518   $first = <span class="keyword">true</span>;
<a name="l00519"></a>00519   <span class="keywordflow">foreach</span>($kv as $k =&gt; $v) {
<a name="l00520"></a>00520    <span class="keywordflow">if</span>(!$first) $sql .= <span class="stringliteral">&quot;,&quot;</span>;
<a name="l00521"></a>00521    
<a name="l00522"></a>00522    <span class="comment">// if its a CMConstant we don&#39;t encapsulate it</span>
<a name="l00523"></a>00523    <span class="keywordflow">if</span>($v instanceof <a class="code" href="class_c_m_constant.html" title="A container for value that need not be modified or encapsulated.">CMConstant</a>)
<a name="l00524"></a>00524     $sql .= <span class="stringliteral">&quot;&#39;&quot;</span> . pg_escape_string($v) . <span class="stringliteral">&quot;&#39;&quot;</span>;
<a name="l00525"></a>00525    <span class="keywordflow">else</span> $sql .= $v;
<a name="l00526"></a>00526     
<a name="l00527"></a>00527    $first = <span class="keyword">false</span>;
<a name="l00528"></a>00528   }
<a name="l00529"></a>00529   
<a name="l00530"></a>00530   <span class="keywordflow">if</span>($this-&gt;<a class="code" href="class_c_m_postgre_s_q_l.html#a4ced4e9cc5497c475c2cd1a03318f45a" title="Perform a query on the database that returns a handle to iterate the results.">query</a>(<span class="stringliteral">&quot;$sql)&quot;</span>)-&gt;success())
<a name="l00531"></a>00531    <span class="keywordflow">return</span> $this-&gt;<a class="code" href="class_c_m_postgre_s_q_l.html#a4ced4e9cc5497c475c2cd1a03318f45a" title="Perform a query on the database that returns a handle to iterate the results.">query</a>(<span class="stringliteral">&quot;select lastval()&quot;</span>, <span class="keyword">false</span>, $a)-&gt;fetch(<span class="stringliteral">&#39;cell&#39;</span>);
<a name="l00532"></a>00532   <span class="keywordflow">return</span> 0;
<a name="l00533"></a>00533  }
<a name="l00534"></a>00534  
<a name="l00540"></a><a class="code" href="class_c_m_postgre_s_q_l.html#a36b890fb5812fc1247b8afe7d56e72ea">00540</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#a36b890fb5812fc1247b8afe7d56e72ea" title="Fetch the list of tables in the active database.">getTableNames</a>($schema = <span class="keyword">false</span>) {
<a name="l00541"></a>00541   $filter = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00542"></a>00542   <span class="keywordflow">if</span>($schema !== <span class="keyword">false</span>)
<a name="l00543"></a>00543    $filter = <span class="stringliteral">&quot;where table_schema=&#39;$schema&#39;&quot;</span>;
<a name="l00544"></a>00544   <span class="keywordflow">return</span> $this-&gt;<a class="code" href="class_c_m_postgre_s_q_l.html#a4ced4e9cc5497c475c2cd1a03318f45a" title="Perform a query on the database that returns a handle to iterate the results.">query</a>(<span class="stringliteral">&quot;select table_schema || &#39;.&#39; || table_name from information_schema.tables $filter order by table_schema, table_name&quot;</span>)-&gt;fetchAll(<span class="stringliteral">&#39;line&#39;</span>, <span class="stringliteral">&#39;vertical&#39;</span>);
<a name="l00545"></a>00545  }
<a name="l00546"></a>00546  
<a name="l00552"></a><a class="code" href="class_c_m_postgre_s_q_l.html#ae7cdaa744d52a1eb0103e377023ca528">00552</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#ae7cdaa744d52a1eb0103e377023ca528" title="Check if a table exists.">tableExists</a>($table) {
<a name="l00553"></a>00553   <span class="keywordflow">return</span> $this-&gt;<a class="code" href="class_c_m_postgre_s_q_l.html#a4ced4e9cc5497c475c2cd1a03318f45a" title="Perform a query on the database that returns a handle to iterate the results.">query</a>(<span class="stringliteral">&quot;select count(1) from information_schema.tables where table_name=?&quot;</span>, $table)-&gt;fetch(<span class="stringliteral">&#39;cell&#39;</span>);
<a name="l00554"></a>00554  }
<a name="l00555"></a>00555 
<a name="l00561"></a><a class="code" href="class_c_m_postgre_s_q_l.html#a7cf4f2839a152f2c11f5893c640c19dd">00561</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#a7cf4f2839a152f2c11f5893c640c19dd" title="Get schema names.">getSchemaNames</a>() {
<a name="l00562"></a>00562   <span class="keywordflow">return</span> $this-&gt;<a class="code" href="class_c_m_postgre_s_q_l.html#a4ced4e9cc5497c475c2cd1a03318f45a" title="Perform a query on the database that returns a handle to iterate the results.">query</a>(<span class="stringliteral">&quot;select distinct table_schema from information_schema.tables order by table_schema&quot;</span>)-&gt;fetchAll(<span class="stringliteral">&#39;line&#39;</span>, <span class="stringliteral">&#39;vertical&#39;</span>);
<a name="l00563"></a>00563  }
<a name="l00564"></a>00564  
<a name="l00575"></a><a class="code" href="class_c_m_postgre_s_q_l.html#aa45cf2b82a91150a11cd11fa0bf2847c">00575</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#aa45cf2b82a91150a11cd11fa0bf2847c" title="Class methods available implemented class.">availableMethods</a>() {
<a name="l00576"></a>00576   <span class="keywordflow">return</span> array(<span class="stringliteral">&#39;commit&#39;</span>, <span class="stringliteral">&#39;delete&#39;</span>, <span class="stringliteral">&#39;disconnect&#39;</span>, <span class="stringliteral">&#39;engine&#39;</span>, <span class="stringliteral">&#39;eraseTable&#39;</span>, <span class="stringliteral">&#39;escapeString&#39;</span>, <span class="stringliteral">&#39;execute&#39;</span>,
<a name="l00577"></a>00577                <span class="stringliteral">&#39;getClientEncoding&#39;</span>, <span class="stringliteral">&#39;getClientVersion&#39;</span>, <span class="stringliteral">&#39;getDatabaseName&#39;</span>, <span class="stringliteral">&#39;getDatabaseNames&#39;</span>,
<a name="l00578"></a>00578                <span class="stringliteral">&#39;getHost&#39;</span>, <span class="stringliteral">&#39;getPort&#39;</span>, <span class="stringliteral">&#39;getProtocolVersion&#39;</span>, <span class="stringliteral">&#39;getSchemaNames&#39;</span>, <span class="stringliteral">&#39;getServerVersion&#39;</span>,
<a name="l00579"></a>00579                <span class="stringliteral">&#39;getTableNames&#39;</span>, <span class="stringliteral">&#39;getTTY&#39;</span>, <span class="stringliteral">&#39;insert&#39;</span>, <span class="stringliteral">&#39;isConnected&#39;</span>, <span class="stringliteral">&#39;ping&#39;</span>, <span class="stringliteral">&#39;query&#39;</span>, <span class="stringliteral">&#39;reconnect&#39;</span>,
<a name="l00580"></a>00580                <span class="stringliteral">&#39;rollback&#39;</span>, <span class="stringliteral">&#39;setAutoCommit&#39;</span>, <span class="stringliteral">&#39;setClientEncoding&#39;</span>, <span class="stringliteral">&#39;tableExists&#39;</span>, <span class="stringliteral">&#39;truncateTable&#39;</span>,
<a name="l00581"></a>00581                <span class="stringliteral">&#39;update&#39;</span>);
<a name="l00582"></a>00582  }
<a name="l00583"></a>00583  
<a name="l00587"></a><a class="code" href="class_c_m_postgre_s_q_l.html#af160f7fbbf281d018ae3162521b8267d">00587</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#af160f7fbbf281d018ae3162521b8267d" title="Check if the database is connected.">isConnected</a>() {
<a name="l00588"></a>00588   <span class="keywordflow">return</span> pg_connection_status($this-&gt;dbh) === PGSQL_CONNECTION_OK;
<a name="l00589"></a>00589  }
<a name="l00590"></a>00590  
<a name="l00596"></a><a class="code" href="class_c_m_postgre_s_q_l.html#abe175fcf658475bc56e9d6fa02bc88ec">00596</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#abe175fcf658475bc56e9d6fa02bc88ec" title="Disconnect database handle.">disconnect</a>() {
<a name="l00597"></a>00597   pg_close($this-&gt;dbh);
<a name="l00598"></a>00598   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00599"></a>00599  }
<a name="l00600"></a>00600  
<a name="l00606"></a><a class="code" href="class_c_m_postgre_s_q_l.html#a8147e0a0a8e607106004e2571195e01c">00606</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#a8147e0a0a8e607106004e2571195e01c" title="Get database product name.">engine</a>() {
<a name="l00607"></a>00607   <span class="keywordflow">return</span> <span class="stringliteral">&quot;PostgreSQL&quot;</span>;
<a name="l00608"></a>00608  }
<a name="l00609"></a>00609  
<a name="l00619"></a><a class="code" href="class_c_m_postgre_s_q_l.html#af5674c27d4a92f6228565010eacbb9cb">00619</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#af5674c27d4a92f6228565010eacbb9cb" title="COMMIT transaction.">commit</a>() {
<a name="l00620"></a>00620   $success = pg_exec($this-&gt;dbh, <span class="stringliteral">&quot;COMMIT&quot;</span>);
<a name="l00621"></a>00621   <span class="keywordflow">if</span>(!$success)
<a name="l00622"></a>00622    $this-&gt;<a class="code" href="class_c_m_error.html#a6d110c63a1c5103df7979612ed5209d3" title="Throw a Warning level message.">throwWarning</a>(<span class="stringliteral">&quot;Failed to commit transaction&quot;</span>);
<a name="l00623"></a>00623   
<a name="l00624"></a>00624   <span class="comment">// due to the way transactions are done, we manually check if auto commit is off and start a</span>
<a name="l00625"></a>00625   <span class="comment">// new transaction</span>
<a name="l00626"></a>00626   <span class="keywordflow">if</span>(!$this-&gt;autoCommit)
<a name="l00627"></a>00627    <span class="keywordflow">if</span>(!pg_exec($this-&gt;dbh, <span class="stringliteral">&quot;BEGIN WORK&quot;</span>))
<a name="l00628"></a>00628     $this-&gt;<a class="code" href="class_c_m_error.html#a6d110c63a1c5103df7979612ed5209d3" title="Throw a Warning level message.">throwWarning</a>(<span class="stringliteral">&quot;Can not begin transaction&quot;</span>);
<a name="l00629"></a>00629    
<a name="l00630"></a>00630   <span class="keywordflow">return</span> $success;
<a name="l00631"></a>00631  }
<a name="l00632"></a>00632 
<a name="l00640"></a><a class="code" href="class_c_m_postgre_s_q_l.html#aea9c1153e0e0fc135f8d513263bf9201">00640</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#aea9c1153e0e0fc135f8d513263bf9201" title="Get an array of database names.">getDatabaseNames</a>() {
<a name="l00641"></a>00641   <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00642"></a>00642  }
<a name="l00643"></a>00643 
<a name="l00653"></a><a class="code" href="class_c_m_postgre_s_q_l.html#afa549adf79e3f8c09fe8f903dd5fbfa7">00653</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#afa549adf79e3f8c09fe8f903dd5fbfa7" title="ROLLBACK transaction.">rollback</a>() {
<a name="l00654"></a>00654   $success = pg_exec($this-&gt;dbh, <span class="stringliteral">&quot;ROLLBACK&quot;</span>);
<a name="l00655"></a>00655   <span class="keywordflow">if</span>(!$success)
<a name="l00656"></a>00656    $this-&gt;<a class="code" href="class_c_m_error.html#a6d110c63a1c5103df7979612ed5209d3" title="Throw a Warning level message.">throwWarning</a>(<span class="stringliteral">&quot;Failed to rollback transaction&quot;</span>);
<a name="l00657"></a>00657   
<a name="l00658"></a>00658   <span class="comment">// due to the way transactions are done, we manually check if auto commit is off and start a</span>
<a name="l00659"></a>00659   <span class="comment">// new transaction</span>
<a name="l00660"></a>00660   <span class="keywordflow">if</span>(!$this-&gt;autoCommit)
<a name="l00661"></a>00661    <span class="keywordflow">if</span>(!pg_exec($this-&gt;dbh, <span class="stringliteral">&quot;BEGIN WORK&quot;</span>))
<a name="l00662"></a>00662     $this-&gt;<a class="code" href="class_c_m_error.html#a6d110c63a1c5103df7979612ed5209d3" title="Throw a Warning level message.">throwWarning</a>(<span class="stringliteral">&quot;Can not begin transaction&quot;</span>);
<a name="l00663"></a>00663    
<a name="l00664"></a>00664   <span class="keywordflow">return</span> $success;
<a name="l00665"></a>00665  }
<a name="l00666"></a>00666 
<a name="l00684"></a><a class="code" href="class_c_m_postgre_s_q_l.html#af569120fcd4d04f33780d9c10daf144c">00684</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#af569120fcd4d04f33780d9c10daf144c" title="Turn autocommit on/off.">setAutoCommit</a>($mode = <span class="keyword">false</span>) {
<a name="l00685"></a>00685   $this-&gt;autoCommit = $mode;
<a name="l00686"></a>00686   <span class="keywordflow">if</span>(!$this-&gt;autoCommit)
<a name="l00687"></a>00687    <span class="keywordflow">if</span>(!pg_exec($this-&gt;dbh, <span class="stringliteral">&quot;BEGIN WORK&quot;</span>))
<a name="l00688"></a>00688     $this-&gt;<a class="code" href="class_c_m_error.html#a6d110c63a1c5103df7979612ed5209d3" title="Throw a Warning level message.">throwWarning</a>(<span class="stringliteral">&quot;Can not begin transaction&quot;</span>);
<a name="l00689"></a>00689   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00690"></a>00690  }
<a name="l00691"></a>00691  
<a name="l00695"></a><a class="code" href="class_c_m_postgre_s_q_l.html#a7516ca30af0db3cdbf9a7739b48ce91d">00695</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#a7516ca30af0db3cdbf9a7739b48ce91d" title="Return the string value of this object.">__toString</a>() {
<a name="l00696"></a>00696   <span class="keywordflow">return</span> <span class="stringliteral">&quot;&lt;&quot;</span> . get_class($this) . <span class="stringliteral">&quot;&gt;&quot;</span>;
<a name="l00697"></a>00697  }
<a name="l00698"></a>00698  
<a name="l00715"></a><a class="code" href="class_c_m_postgre_s_q_l.html#a7e4edd82127e0c6a2f42158fdbb258d3">00715</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#a7e4edd82127e0c6a2f42158fdbb258d3" title="Erase (not truncate) a table.">eraseTable</a>($tableName) {
<a name="l00716"></a>00716   <span class="comment">// need a valid database handle</span>
<a name="l00717"></a>00717   <span class="keywordflow">if</span>($this-&gt;dbh === <span class="keyword">false</span>)
<a name="l00718"></a>00718    <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00719"></a>00719   
<a name="l00720"></a>00720   $q = $this-&gt;<a class="code" href="class_c_m_postgre_s_q_l.html#a4ced4e9cc5497c475c2cd1a03318f45a" title="Perform a query on the database that returns a handle to iterate the results.">query</a>(<span class="stringliteral">&quot;DELETE FROM \&quot;$tableName\&quot; WHERE 1&quot;</span>);
<a name="l00721"></a>00721   <span class="keywordflow">return</span> $q-&gt;success();
<a name="l00722"></a>00722  }
<a name="l00723"></a>00723  
<a name="l00739"></a><a class="code" href="class_c_m_postgre_s_q_l.html#aff013143f73f33653e2f60fecbde00cb">00739</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#aff013143f73f33653e2f60fecbde00cb" title="TRUNCATE table.">truncateTable</a>($tableName) {
<a name="l00740"></a>00740   <span class="comment">// need a valid database handle</span>
<a name="l00741"></a>00741   <span class="keywordflow">if</span>($this-&gt;dbh === <span class="keyword">false</span>)
<a name="l00742"></a>00742    <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00743"></a>00743   
<a name="l00744"></a>00744   $q = $this-&gt;<a class="code" href="class_c_m_postgre_s_q_l.html#a4ced4e9cc5497c475c2cd1a03318f45a" title="Perform a query on the database that returns a handle to iterate the results.">query</a>(<span class="stringliteral">&quot;TRUNCATE TABLE \&quot;$tableName\&quot;&quot;</span>);
<a name="l00745"></a>00745   <span class="keywordflow">return</span> $q-&gt;success();
<a name="l00746"></a>00746  }
<a name="l00747"></a>00747  
<a name="l00760"></a><a class="code" href="class_c_m_postgre_s_q_l.html#ac32a7f2a2c349c061f600bc0ac2fec86">00760</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#ac32a7f2a2c349c061f600bc0ac2fec86" title="UPDATE statement.">update</a>($tableName, $newvalues, $criteria = <span class="keyword">false</span>, $a = <span class="keyword">false</span>) {
<a name="l00761"></a>00761   <span class="comment">// $a must be an array</span>
<a name="l00762"></a>00762   <span class="keywordflow">if</span>(!is_array($a))
<a name="l00763"></a>00763    $a = array();
<a name="l00764"></a>00764   
<a name="l00765"></a>00765   $sql = <span class="stringliteral">&quot;UPDATE `$tableName` SET &quot;</span>;
<a name="l00766"></a>00766   $first = <span class="keyword">true</span>;
<a name="l00767"></a>00767   <span class="keywordflow">foreach</span>($newvalues as $k =&gt; $v) {
<a name="l00768"></a>00768    <span class="keywordflow">if</span>(!$first) $sql .= <span class="stringliteral">&quot;,&quot;</span>;
<a name="l00769"></a>00769    
<a name="l00770"></a>00770    <span class="comment">// if its a CMConstant we don&#39;t encapsulate it</span>
<a name="l00771"></a>00771    <span class="keywordflow">if</span>($v instanceof <a class="code" href="class_c_m_constant.html" title="A container for value that need not be modified or encapsulated.">CMConstant</a>)
<a name="l00772"></a>00772     $sql .= <span class="stringliteral">&quot;$k=$v&quot;</span>;
<a name="l00773"></a>00773    <span class="keywordflow">else</span> $sql .= <span class="stringliteral">&quot;$k=&#39;&quot;</span> . pg_escape_string($v) . <span class="stringliteral">&quot;&#39;&quot;</span>;
<a name="l00774"></a>00774    
<a name="l00775"></a>00775    $first = <span class="keyword">false</span>;
<a name="l00776"></a>00776   }
<a name="l00777"></a>00777   
<a name="l00778"></a>00778   <span class="comment">// add WHERE clause</span>
<a name="l00779"></a>00779   <span class="keywordflow">if</span>($criteria !== <span class="keyword">false</span>) {
<a name="l00780"></a>00780    $sql .= <span class="stringliteral">&quot; WHERE &quot;</span>;
<a name="l00781"></a>00781    $first = <span class="keyword">true</span>;
<a name="l00782"></a>00782    <span class="keywordflow">foreach</span>($criteria as $k =&gt; $v) {
<a name="l00783"></a>00783     <span class="keywordflow">if</span>(!$first) $sql .= <span class="stringliteral">&quot; AND &quot;</span>;
<a name="l00784"></a>00784     
<a name="l00785"></a>00785     <span class="comment">// if its a CMConstant we don&#39;t encapsulate it</span>
<a name="l00786"></a>00786     <span class="keywordflow">if</span>($v instanceof <a class="code" href="class_c_m_constant.html" title="A container for value that need not be modified or encapsulated.">CMConstant</a>)
<a name="l00787"></a>00787      $sql .= <span class="stringliteral">&quot;$k=$v&quot;</span>;
<a name="l00788"></a>00788     <span class="keywordflow">else</span> $sql .= <span class="stringliteral">&quot;$k=&#39;&quot;</span> . pg_escape_string($v) . <span class="stringliteral">&quot;&#39;&quot;</span>;
<a name="l00789"></a>00789     
<a name="l00790"></a>00790     $first = <span class="keyword">false</span>;
<a name="l00791"></a>00791    }
<a name="l00792"></a>00792   }
<a name="l00793"></a>00793   
<a name="l00794"></a>00794   <span class="keywordflow">if</span>(isset($a[<span class="stringliteral">&#39;print&#39;</span>]))
<a name="l00795"></a>00795    echo $sql;
<a name="l00796"></a>00796   
<a name="l00797"></a>00797   $q = $this-&gt;<a class="code" href="class_c_m_postgre_s_q_l.html#a4ced4e9cc5497c475c2cd1a03318f45a" title="Perform a query on the database that returns a handle to iterate the results.">query</a>($sql, <span class="keyword">false</span>, $a);
<a name="l00798"></a>00798   <span class="keywordflow">if</span>($q-&gt;success())
<a name="l00799"></a>00799    <span class="keywordflow">return</span> $q-&gt;affectedRows();
<a name="l00800"></a>00800   <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00801"></a>00801  }
<a name="l00802"></a>00802  
<a name="l00814"></a><a class="code" href="class_c_m_postgre_s_q_l.html#a2415ba06f043f104ed33b9571f200fc8">00814</a>  <span class="keyword">public</span> function <span class="keyword">delete</span>($tableName, $criteria = <span class="keyword">false</span>, $a = <span class="keyword">false</span>) {
<a name="l00815"></a>00815   <span class="comment">// $a must be an array</span>
<a name="l00816"></a>00816   <span class="keywordflow">if</span>(!is_array($a))
<a name="l00817"></a>00817    $a = array();
<a name="l00818"></a>00818   
<a name="l00819"></a>00819   $sql = <span class="stringliteral">&quot;DELETE FROM `$tableName`&quot;</span>;
<a name="l00820"></a>00820   
<a name="l00821"></a>00821   <span class="comment">// add WHERE clause</span>
<a name="l00822"></a>00822   <span class="keywordflow">if</span>($criteria !== <span class="keyword">false</span>) {
<a name="l00823"></a>00823    $sql .= <span class="stringliteral">&quot; WHERE &quot;</span>;
<a name="l00824"></a>00824    $first = <span class="keyword">true</span>;
<a name="l00825"></a>00825    <span class="keywordflow">foreach</span>($criteria as $k =&gt; $v) {
<a name="l00826"></a>00826     <span class="keywordflow">if</span>(!$first) $sql .= <span class="stringliteral">&quot; AND &quot;</span>;
<a name="l00827"></a>00827     
<a name="l00828"></a>00828     <span class="comment">// if its a CMConstant we don&#39;t encapsulate it</span>
<a name="l00829"></a>00829     <span class="keywordflow">if</span>($v instanceof <a class="code" href="class_c_m_constant.html" title="A container for value that need not be modified or encapsulated.">CMConstant</a>)
<a name="l00830"></a>00830      $sql .= <span class="stringliteral">&quot;$k=$v&quot;</span>;
<a name="l00831"></a>00831     <span class="keywordflow">else</span> $sql .= <span class="stringliteral">&quot;$k=&#39;&quot;</span> . pg_escape_string($v) . <span class="stringliteral">&quot;&#39;&quot;</span>;
<a name="l00832"></a>00832     
<a name="l00833"></a>00833     $first = <span class="keyword">false</span>;
<a name="l00834"></a>00834    }
<a name="l00835"></a>00835   }
<a name="l00836"></a>00836   
<a name="l00837"></a>00837   <span class="keywordflow">if</span>(isset($a[<span class="stringliteral">&#39;print&#39;</span>]))
<a name="l00838"></a>00838    echo $sql;
<a name="l00839"></a>00839   
<a name="l00840"></a>00840   $q = $this-&gt;<a class="code" href="class_c_m_postgre_s_q_l.html#a4ced4e9cc5497c475c2cd1a03318f45a" title="Perform a query on the database that returns a handle to iterate the results.">query</a>($sql, <span class="keyword">false</span>, $a);
<a name="l00841"></a>00841   <span class="keywordflow">if</span>($q-&gt;success())
<a name="l00842"></a>00842    <span class="keywordflow">return</span> $q-&gt;affectedRows();
<a name="l00843"></a>00843   <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00844"></a>00844  }
<a name="l00845"></a>00845  
<a name="l00855"></a><a class="code" href="class_c_m_postgre_s_q_l.html#ad46d13881d4b1b0351d97290062ddb56">00855</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#ad46d13881d4b1b0351d97290062ddb56" title="Gets the client encoding.">getClientEncoding</a>() {
<a name="l00856"></a>00856   <span class="keywordflow">return</span> pg_client_encoding($this-&gt;dbh);
<a name="l00857"></a>00857  }
<a name="l00858"></a>00858  
<a name="l00866"></a><a class="code" href="class_c_m_postgre_s_q_l.html#a57c19c642ab3023e28d10c50f86ff0a8">00866</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#a57c19c642ab3023e28d10c50f86ff0a8" title="Reconnect (reset) the connection.">reconnect</a>() {
<a name="l00867"></a>00867   <span class="keywordflow">return</span> pg_connection_reset($this-&gt;dbh);
<a name="l00868"></a>00868  }
<a name="l00869"></a>00869  
<a name="l00877"></a><a class="code" href="class_c_m_postgre_s_q_l.html#a6c2092833f367c0aefa1eee1065a2e9e">00877</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#a6c2092833f367c0aefa1eee1065a2e9e" title="Get the database name.">getDatabaseName</a>() {
<a name="l00878"></a>00878   <span class="keywordflow">return</span> pg_dbname($this-&gt;dbh);
<a name="l00879"></a>00879  }
<a name="l00880"></a>00880  
<a name="l00886"></a><a class="code" href="class_c_m_postgre_s_q_l.html#a39895a44b52bdced039e698588aaf18e">00886</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#a39895a44b52bdced039e698588aaf18e" title="Returns the host name associated with this connection.">getHost</a>() {
<a name="l00887"></a>00887   <span class="keywordflow">return</span> pg_host($this-&gt;dbh);
<a name="l00888"></a>00888  }
<a name="l00889"></a>00889  
<a name="l00895"></a><a class="code" href="class_c_m_postgre_s_q_l.html#a6dad377f74b0ce6f21b485ba11052746">00895</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#a6dad377f74b0ce6f21b485ba11052746" title="Pings a database connection and tries to reconnect it if it is broken.">ping</a>() {
<a name="l00896"></a>00896   <span class="keywordflow">return</span> pg_ping($this-&gt;dbh);
<a name="l00897"></a>00897  }
<a name="l00898"></a>00898  
<a name="l00905"></a><a class="code" href="class_c_m_postgre_s_q_l.html#afd4db46d3c12f47f0bee19cd2101be64">00905</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#afd4db46d3c12f47f0bee19cd2101be64" title="Return the port number associated with this connection.">getPort</a>() {
<a name="l00906"></a>00906   <span class="keywordflow">return</span> pg_port($this-&gt;dbh);
<a name="l00907"></a>00907  }
<a name="l00908"></a>00908  
<a name="l00922"></a><a class="code" href="class_c_m_postgre_s_q_l.html#ac221b90197ad91ac98986b15141eb499">00922</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#ac221b90197ad91ac98986b15141eb499" title="Set the client encoding.">setClientEncoding</a>($encoding) {
<a name="l00923"></a>00923   <span class="keywordflow">return</span> pg_set_client_encoding($this-&gt;dbh, $encoding);
<a name="l00924"></a>00924  }
<a name="l00925"></a>00925  
<a name="l00936"></a><a class="code" href="class_c_m_postgre_s_q_l.html#a415e7833ef2683300fd7bc775c46d6cb">00936</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#a415e7833ef2683300fd7bc775c46d6cb" title="Return the TTY name associated with the connection.">getTTY</a>() {
<a name="l00937"></a>00937   <span class="keywordflow">return</span> pg_tty($this-&gt;dbh);
<a name="l00938"></a>00938  }
<a name="l00939"></a>00939  
<a name="l00943"></a><a class="code" href="class_c_m_postgre_s_q_l.html#acc8b801086cef69cbf92b77ee7434be0">00943</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#acc8b801086cef69cbf92b77ee7434be0" title="Get the client version.">getClientVersion</a>() {
<a name="l00944"></a>00944   $v = pg_version();
<a name="l00945"></a>00945   <span class="keywordflow">return</span> $v[<span class="stringliteral">&#39;client&#39;</span>];
<a name="l00946"></a>00946  }
<a name="l00947"></a>00947  
<a name="l00951"></a><a class="code" href="class_c_m_postgre_s_q_l.html#a915c3328b367338a7c0eddb1e3294e9a">00951</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#a915c3328b367338a7c0eddb1e3294e9a" title="Get the protocol version.">getProtocolVersion</a>() {
<a name="l00952"></a>00952   $v = pg_version();
<a name="l00953"></a>00953   <span class="keywordflow">return</span> $v[<span class="stringliteral">&#39;protocol&#39;</span>];
<a name="l00954"></a>00954  }
<a name="l00955"></a>00955  
<a name="l00959"></a><a class="code" href="class_c_m_postgre_s_q_l.html#a2d047b148eb053baba2150cc7d5d9545">00959</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#a2d047b148eb053baba2150cc7d5d9545" title="Get the server version.">getServerVersion</a>() {
<a name="l00960"></a>00960   $v = pg_version();
<a name="l00961"></a>00961   <span class="keywordflow">return</span> $v[<span class="stringliteral">&#39;server_version&#39;</span>];
<a name="l00962"></a>00962  }
<a name="l00963"></a>00963  
<a name="l00970"></a><a class="code" href="class_c_m_postgre_s_q_l.html#a2d931763c47d46ab7c26ba4e69d969d7">00970</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#a2d931763c47d46ab7c26ba4e69d969d7" title="Escape a string based on the correct rules of the database engine.">escapeString</a>($str) {
<a name="l00971"></a>00971   <span class="keywordflow">return</span> pg_escape_string($str); 
<a name="l00972"></a>00972  }
<a name="l00973"></a>00973  
<a name="l00980"></a><a class="code" href="class_c_m_postgre_s_q_l.html#a7327ec53765f61a4a9d715133d2ea2db">00980</a>  <span class="keyword">public</span> function <a class="code" href="class_c_m_postgre_s_q_l.html#a7327ec53765f61a4a9d715133d2ea2db" title="Return the auto commit status.">getAutoCommit</a>() {
<a name="l00981"></a>00981   <span class="keywordflow">return</span> $this-&gt;autoCommit;
<a name="l00982"></a>00982  }
<a name="l00983"></a>00983  
<a name="l00984"></a>00984 }
<a name="l00985"></a>00985 
<a name="l00986"></a>00986 ?&gt;
</pre></div></div>
<hr class="footer"/><address style="text-align: right;"><small>Generated by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
